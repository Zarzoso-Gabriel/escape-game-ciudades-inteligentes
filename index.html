<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Game: El Misterio de la Ciudad Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #0a192f;
            color: #e6f1ff;
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(100, 255, 218, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(100, 255, 218, 0.05) 0%, transparent 20%);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(16, 42, 87, 0.8);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 255, 218, 0.2);
        }

        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #64ffda;
            text-shadow: 0 0 15px rgba(100, 255, 218, 0.7);
            background: linear-gradient(90deg, #64ffda, #a8ffeb);
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #64ffda;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #a8ffeb;
        }

        p {
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .scene {
            display: none;
            background: rgba(16, 42, 87, 0.8);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 255, 218, 0.2);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .active {
            display: block;
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #0a192f, #112240);
            color: #64ffda;
            padding: 14px 28px;
            border: 1px solid #64ffda;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            background: #64ffda;
            color: #0a192f;
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.7);
            transform: translateY(-3px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-hint {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid #64ffda;
            color: #64ffda;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn-hint:hover {
            background: rgba(100, 255, 218, 0.2);
        }

        .btn-reset {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 107, 107, 0.05));
            color: #ff6b6b;
            padding: 12px 20px;
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.1);
            backdrop-filter: blur(5px);
            position: relative;
            overflow: hidden;
        }

        .btn-reset::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 107, 107, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn-reset:hover::before {
            left: 100%;
        }

        .btn-reset:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(255, 107, 107, 0.1));
            color: #ff6b6b;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
            transform: translateY(-3px);
            border-color: rgba(255, 107, 107, 0.5);
        }

        .btn-reset:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.2);
        }

        .btn-reset svg {
            width: 16px;
            height: 16px;
            transition: transform 0.5s ease;
        }

        .btn-reset:hover svg {
            transform: rotate(360deg);
        }

        input, select, textarea {
            background: rgba(10, 25, 47, 0.7);
            border: 1px solid #64ffda;
            color: #e6f1ff;
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        .puzzle-container {
            background: rgba(23, 42, 70, 0.9);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 1px solid #233554;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .timer {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(16, 42, 87, 0.9);
            padding: 12px 18px;
            border-radius: 8px;
            border: 1px solid #64ffda;
            font-size: 1.3rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .hint {
            background: rgba(100, 255, 218, 0.1);
            border-left: 4px solid #64ffda;
            padding: 15px;
            margin: 20px 0;
            font-style: italic;
            border-radius: 0 8px 8px 0;
            display: none;
        }

        .success {
            color: #64ffda;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            animation: pulse 2s infinite;
            font-size: 1.2rem;
        }

        .error {
            color: #ff6b6b;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            font-size: 1.1rem;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .code-display {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #233554;
            font-size: 1.2rem;
            text-align: center;
        }

        .bin {
            min-height: 120px;
            border: 2px dashed;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .waste-item {
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            cursor: move;
            margin: 5px;
            transition: all 0.3s ease;
            text-align: center;
        }

        .waste-item:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
        }

        .option-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            background: rgba(23, 42, 70, 0.9);
            border: 1px solid #233554;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: rgba(35, 53, 84, 0.9);
            transform: translateY(-3px);
        }

        .option.selected {
            background: rgba(100, 255, 218, 0.2);
            border-color: #64ffda;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        .matching-game {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .matching-item {
            padding: 15px;
            background: rgba(23, 42, 70, 0.95);
            border: 1px solid #64ffda;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transform: translateY(-2px);
            border: 2px solid #64ffda;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(100, 255, 218, 0.2);
        }

        .matching-item:hover {
            background: rgba(35, 53, 84, 0.95);
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
        }

        .matching-item.matched {
            background: rgba(100, 255, 218, 0.3);
            border-color: #64ffda;
            cursor: default;
            box-shadow: 0 4px 12px rgba(100, 255, 218, 0.3);
        }

        .matching-item.matched {
            background: rgba(100, 255, 218, 0.3);
            border-color: #64ffda;
            cursor: default;
        }

        .feedback-container {
            min-height: 80px;
            margin: 20px 0;
        }

        .reset-container {
            display: flex;
            justify-content: flex-end;
            margin: 20px 0;
            padding: 10px 0;
            border-top: 1px solid rgba(100, 255, 218, 0.1);
        }

        .waste-items-container {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .progress-bar {
            height: 10px;
            background: rgba(23, 42, 70, 0.9);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #64ffda, #a8ffeb);
            border-radius: 5px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .final-message {
            text-align: center;
            padding: 40px;
            background: rgba(16, 42, 87, 0.9);
            border-radius: 15px;
            margin-top: 30px;
            border: 1px solid rgba(100, 255, 218, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .final-time {
            font-size: 1.8rem;
            color: #64ffda;
            margin: 25px 0;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            h2 {
                font-size: 1.7rem;
            }
            
            .timer {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
            
            .matching-game {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .btn {
                display: block;
                width: 100%;
                margin: 10px 0;
            }
        }
    </style>
</head>
<body>
    <div class="timer" id="timer">Tiempo: 00:00</div>
    <div class="progress-bar">
        <div class="progress" id="progress"></div>
    </div>
    
    <div class="container">
        <header>
            <h1>Escape Game: El Misterio de la Ciudad Inteligente</h1>
            <p>Ayuda a resolver los desafíos tecnológicos de una ciudad española inteligente</p>
        </header>

        <!-- Escena de introducción -->
        <div id="scene-intro" class="scene active">
            <h2>¡Bienvenido/a!</h2>
            <p>Eres un/a consultor/a especializado/a en ciudades inteligentes. Has sido contratado/a por el ayuntamiento de una ciudad española para resolver una serie de problemas tecnológicos que están afectando a sus sistemas inteligentes.</p>
            <p>Tu misión es resolver 30 desafíos relacionados con diferentes aspectos de una smart city para restaurar el funcionamiento completo de la ciudad.</p>
            <p>Tienes un tiempo limitado antes de que los sistemas fallen completamente. ¡Demuestra tu experticia en tecnología urbana!</p>
            <button class="btn" onclick="startGame()">Comenzar el Desafío</button>
        </div>

        <!-- Escena 1: Sistema de transporte -->
        <div id="scene-1" class="scene">
            <h2>Fase 1: Sistema de Transporte Inteligente</h2>
            <p>El sistema de transporte público de la ciudad ha sufrido un fallo. Para reactivarlo, necesitas descifrar el código de acceso.</p>
            
            <div class="puzzle-container">
                <p>Encuentra el patrón en esta secuencia de números relacionados con el transporte urbano:</p>
                <div class="code-display">2, 4, 8, 16, 32, ?</div>
                <p>¿Cuál es el siguiente número en la secuencia?</p>
                <input type="text" id="transport-answer" placeholder="Ingresa tu respuesta">
                <div class="feedback-container" id="transport-feedback"></div>
                <button class="btn" id="transport-verify" onclick="checkTransportAnswer()">Verificar</button>
                <button class="btn" id="transport-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-1')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-1">
                <p>Pista: Observa cómo cada número se relaciona con el anterior multiplicando por un factor constante.</p>
            </div>
        </div>

        <!-- Escena 2: Movilidad como Servicio (MaaS) -->
        <div id="scene-2" class="scene">
            <h2>Fase 2: Plataforma de Movilidad como Servicio</h2>
            <p>La plataforma MaaS (Mobility as a Service) necesita integrar correctamente los diferentes modos de transporte.</p>
            
            <div class="puzzle-container">
                <p>Relaciona cada característica de MaaS con su beneficio correspondiente:</p>
                
                <div class="matching-game">
                    <div class="matching-column">
                        <h3>Características de MaaS</h3>
                        <div id="caracteristicas-container-20">
                        </div>
                    </div>
                    <div class="matching-column">
                        <h3>Beneficios</h3>
                        <div id="beneficioA" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Facilita el uso combinado de transporte público y privado</div>
                        <div id="beneficioB" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Permite optimizar tiempos de viaje</div>
                        <div id="beneficioC" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Elimina la necesidad de múltiples apps y suscripciones</div>
                        <div id="beneficioD" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Garantiza disponibilidad de medios de transporte</div>
                    </div>
                </div>
                
                <div class="reset-container">
                    <button class="btn-reset" onclick="resetMatchingGame(2)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Reiniciar
                    </button>
                </div>
                
                <div class="feedback-container" id="maas-feedback"></div>
                <button class="btn" id="maas-verify" onclick="checkMaasAnswer()">Verificar</button>
                <button class="btn" id="maas-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-20')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-20">
                <p>Pista: Piensa en cómo cada característica resuelve un problema específico de movilidad urbana.</p>
            </div>
        </div>

        <!-- Escena 3: Big Data Urbano -->
        <div id="scene-3" class="scene">
            <h2>Fase 3: Análisis de Big Data Urbano</h2>
            <p>El sistema de análisis de datos urbanos ha identificado un patrón anómalo. Debes interpretar los datos.</p>
            
            <div class="puzzle-container">
                <p>Observa esta serie de datos de consumo energético en diferentes distritos:</p>
                <div class="code-display">Distrito A: 125 MWh<br>Distrito B: 180 MWh<br>Distrito C: 95 MWh<br>Distrito D: 210 MWh<br>Distrito E: 140 MWh</div>
                <p>¿Cuál es el consumo energético medio de estos distritos?</p>
                <input type="text" id="data-answer" placeholder="Ingresa tu respuesta en MWh">
                <div class="feedback-container" id="data-feedback"></div>
                <button class="btn" id="data-verify" onclick="checkDataAnswer()">Verificar</button>
                <button class="btn" id="data-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-6')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-6">
                <p>Pista: Calcula la suma de todos los valores y divide entre el número de distritos.</p>
            </div>
        </div>

        <!-- Escena 4: Gobernanza de Datos -->
        <div id="scene-4" class="scene">
            <h2>Fase 4: Gobernanza de Datos Urbanos</h2>
            <p>El sistema de gobernanza de datos necesita que identifiques principios éticos.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estos NO es un principio fundamental de la gobernanza de datos en ciudades inteligentes?</p>
                <div class="option-group" id="governance-options">
                </div>
                <div class="feedback-container" id="governance-feedback"></div>
                <button class="btn" id="governance-verify" onclick="checkGovernanceAnswer()">Verificar</button>
                <button class="btn" id="governance-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-14')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-14">
                <p>Pista: Piensa en prácticas que respeten los derechos de los ciudadanos.</p>
            </div>
        </div>

        <!-- Escena 5: Energías Renovables -->
        <div id="scene-5" class="scene">
            <h2>Fase 5: Integración de Energías Renovables</h2>
            <p>La ciudad debe elegir la mejor ubicación para una nueva instalación de energía renovable.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas ubicaciones es MÁS adecuada para una planta de energía solar fotovoltaica?</p>
                <select id="solar-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="solar-feedback"></div>
                <button class="btn" id="solar-verify" onclick="checkSolarAnswer()">Verificar</button>
                <button class="btn" id="solar-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-25')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-25">
                <p>Pista: Piensa en ubicaciones con máxima exposición solar y mínimo impacto ambiental.</p>
            </div>
        </div>

        <!-- Escena 6: Movilidad Activa -->
        <div id="scene-6" class="scene">
            <h2>Fase 6: Fomento de la Movilidad Activa</h2>
            <p>El plan de movilidad activa necesita identificar infraestructuras adecuadas.</p>
            
            <div class="puzzle-container">
                <p>Selecciona las infraestructuras que SÍ fomentan la movilidad activa (caminar y bicicleta) (4 respuestas correctas):</p>
                <div class="option-group" id="active-options">
                </div>
                
                <div class="feedback-container" id="active-feedback"></div>
                <button class="btn" id="active-verify" onclick="checkActiveAnswer()">Verificar</button>
                <button class="btn" id="active-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-28')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-28">
                <p>Pista: Piensa en infraestructuras que hagan más seguros y atractivos los desplazamientos a pie y en bici.</p>
            </div>
        </div>

        <!-- Escena 7: Turismo Inteligente -->
        <div id="scene-7" class="scene">
            <h2>Fase 7: Sistema de Turismo Inteligente</h2>
            <p>La plataforma de turismo inteligente necesita que identifiques las tecnologías más adecuadas.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas tecnologías NO se utiliza típicamente en sistemas de turismo inteligente?</p>
                <div class="option-group" id="tourism-options">
                </div>
                <div class="feedback-container" id="tourism-feedback"></div>
                <button class="btn" id="tourism-verify" onclick="checkTourismAnswer()">Verificar</button>
                <button class="btn" id="tourism-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-11')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-11">
                <p>Pista: Piensa en tecnologías relevantes para la experiencia turística.</p>
            </div>
        </div>

        <!-- Escena 8: Separación de residuos orgánicos -->
        <div id="scene-8" class="scene">
            <h2>Fase 8: Gestión de Residuos Orgánicos</h2>
            <p>El nuevo sistema de recogida de residuos orgánicos necesita que identifiques correctamente los materiales compostables.</p>
            
            <div class="puzzle-container">
                <p>Selecciona los residuos que SÍ pueden ir al contenedor de orgánica (marrón) (6 respuestas correctas):</p>
                <div class="option-group" id="organica-options">
                </div>
                
                <div class="feedback-container" id="organica-feedback"></div>
                <button class="btn" id="organica-verify" onclick="checkOrganicaAnswer()">Verificar</button>
                <button class="btn" id="organica-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-17')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-17">
                <p>Pista: Los residuos orgánicos son materiales biodegradables que pueden convertirse en compost.</p>
            </div>
        </div>

        <!-- Escena 9: Sistema de residuos -->
        <div id="scene-9" class="scene">
            <h2>Fase 9: Gestión Inteligente de Residuos</h2>
            <p>Los sensores de los contenedores de reciclaje han dejado de funcionar. Para reactivarlos, debes ordenar correctamente los tipos de residuos.</p>
            
            <div class="puzzle-container">
                <p>Arrastra los tipos de residuos a los contenedores correctos:</p>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #ffeb3b; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: #333; font-weight: bold;">Amarillo</div>
                        <div id="yellow-bin" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #ffeb3b;"></div>
                    </div>
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #4caf50; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: white; font-weight: bold;">Verde</div>
                        <div id="green-bin" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #4caf50;"></div>
                    </div>
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #2196f3; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: white; font-weight: bold;">Azul</div>
                        <div id="blue-bin" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #2196f3;"></div>
                    </div>
                </div>
                
                <div class="waste-items-container" id="waste-items-container-3">
                </div>
                
                <div class="feedback-container" id="waste-feedback"></div>
                <button class="btn" id="waste-verify" onclick="checkWasteAnswer()" style="margin-top: 20px;">Verificar</button>
                <button class="btn" id="waste-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-3')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-3">
                <p>Pista: Amarillo: envases de plástico, latas y briks. Azul: papel y cartón. Verde: vidrio.</p>
            </div>
        </div>

        <!-- Escena 10: Movilidad Sostenible -->
        <div id="scene-10" class="scene">
            <h2>Fase 10: Plan de Movilidad Sostenible</h2>
            <p>La ciudad necesita elegir la mejor estrategia para promover la movilidad sostenible.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas medidas tiene MAYOR impacto en la reducción del uso del coche privado en el centro urbano?</p>
                <select id="mobility-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="mobility-feedback"></div>
                <button class="btn" id="mobility-verify" onclick="checkMobilityAnswer()">Verificar</button>
                <button class="btn" id="mobility-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-23')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-23">
                <p>Pista: La solución aborda el problema desde múltiples frentes: limitación de acceso, oferta alternativa y seguridad en desplazamientos.</p>
            </div>
        </div>

        <!-- Escena 11: Edificios Inteligentes -->
        <div id="scene-11" class="scene">
            <h2>Fase 11: Gestión de Edificios Inteligentes</h2>
            <p>El sistema de gestión energética de un edificio inteligente necesita reprogramación.</p>
            
            <div class="puzzle-container">
                <p>Un edificio inteligente reduce su consumo energético un 15% tras una renovación. Si antes consumía 2000 kWh mensuales, ¿cuál es su nuevo consumo?</p>
                <input type="text" id="building-answer" placeholder="Ingresa tu respuesta en kWh">
                <div class="feedback-container" id="building-feedback"></div>
                <button class="btn" id="building-verify" onclick="checkBuildingAnswer()">Verificar</button>
                <button class="btn" id="building-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-8')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-8">
                <p>Pista: Calcula el 15% de reducción y réstalo del consumo original.</p>
            </div>
        </div>

        <!-- Escena 12: Gestión del Agua -->
        <div id="scene-12" class="scene">
            <h2>Fase 12: Sistema Inteligente de Gestión del Agua</h2>
            <p>El sistema de gestión de agua potable necesita optimización para reducir pérdidas.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas tecnologías es MÁS efectiva para detectar fugas en la red de distribución de agua?</p>
                <select id="water-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="water-feedback"></div>
                <button class="btn" id="water-verify" onclick="checkWaterAnswer()">Verificar</button>
                <button class="btn" id="water-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-21')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-21">
                <p>Pista: Piensa en tecnologías que permitan monitorización continua y detección temprana.</p>
            </div>
        </div>

        <!-- Escena 13: Biodiversidad Urbana -->
        <div id="scene-13" class="scene">
            <h2>Fase 13: Fomento de la Biodiversidad Urbana</h2>
            <p>El plan de biodiversidad necesita identificar acciones beneficiosas.</p>
            
            <div class="puzzle-container">
                <p>Selecciona las acciones que SÍ fomentan la biodiversidad en entornos urbanos (5 respuestas correctas):</p>
                <div class="option-group" id="biodiversity-options">
                </div>
                
                <div class="feedback-container" id="biodiversity-feedback"></div>
                <button class="btn" id="biodiversity-verify" onclick="checkBiodiversityAnswer()">Verificar</button>
                <button class="btn" id="biodiversity-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-30')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-30">
                <p>Pista: Las acciones que favorecen la biodiversidad crean habitats para diferentes especies.</p>
            </div>
        </div>

        <!-- Escena 14: Economía Circular -->
        <div id="scene-14" class="scene">
            <h2>Fase 14: Sistema de Economía Circular</h2>
            <p>La plataforma de economía circular necesita que identifiques prácticas sostenibles.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas NO es una práctica característica de economía circular?</p>
                <div class="option-group" id="circular-options">
                </div>
                <div class="feedback-container" id="circular-feedback"></div>
                <button class="btn" id="circular-verify" onclick="checkCircularAnswer()">Verificar</button>
                <button class="btn" id="circular-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-13')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-13">
                <p>Pista: La economía circular busca eliminar los residuos y mantener los materiales en uso.</p>
            </div>
        </div>

        <!-- Escena 15: Planificación Urbana Sostenible -->
        <div id="scene-15" class="scene">
            <h2>Fase 15: Planificación Urbana Sostenible</h2>
            <p>El sistema de planificación urbana necesita que priorices proyectos según criterios de sostenibilidad.</p>
            
            <div class="puzzle-container">
                <p>Ordena estos proyectos de planificación urbana del más prioritario (1) al menos prioritario (4) arrastrando los proyectos (no los números):</p>
                
                <div id="planificacion-container" style="display: grid; grid-template-columns: 1fr; gap: 15px; margin: 20px 0;">
                </div>
                
                <div class="reset-container">
                    <button class="btn-reset" onclick="resetPlanificacion()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Reiniciar
                    </button>
                </div>
                
                <div class="feedback-container" id="planificacion-feedback"></div>
                <button class="btn" id="planificacion-verify" onclick="checkPlanificacionAnswer()">Verificar</button>
                <button class="btn" id="planificacion-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-19')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-19">
                <p>Pista: Considera el orden de intervención: primero lo que genera mayores beneficios ambientales a largo plazo, luego eficiencia operativa.</p>
            </div>
        </div>

        <!-- Escena 16: Huertos Urbanos -->
        <div id="scene-16" class="scene">
            <h2>Fase 16: Gestión de Huertos Urbanos</h2>
            <p>El programa de huertos urbanos necesita identificar prácticas sostenibles.</p>
            
            <div class="puzzle-container">
                <p>Selecciona las prácticas que SÍ son sostenibles para huertos urbanos (5 respuestas correctas):</p>
                <div class="option-group" id="garden-options">
                </div>
                
                <div class="feedback-container" id="garden-feedback"></div>
                <button class="btn" id="garden-verify" onclick="checkGardenAnswer()">Verificar</button>
                <button class="btn" id="garden-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-27')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-27">
                <p>Pista: Las prácticas sostenibles respetan el medio ambiente y promueven la biodiversidad.</p>
            </div>
        </div>

        <!-- Escena 17: Movilidad Eléctrica -->
        <div id="scene-17" class="scene">
            <h2>Fase 17: Movilidad Eléctrica</h2>
            <p>El sistema de gestión de puntos de carga para vehículos eléctricos necesita reconfigurarse.</p>
            
            <div class="puzzle-container">
                <p>Un coche eléctrico tiene una autonomía de 300 km. Si recorre 45 km diarios de media, ¿cuántos días puede circular sin necesidad de recargar?</p>
                <input type="text" id="ev-answer" placeholder="Ingresa tu respuesta en días">
                <div class="feedback-container" id="ev-feedback"></div>
                <button class="btn" id="ev-verify" onclick="checkEvAnswer()">Verificar</button>
                <button class="btn" id="ev-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-5')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-5">
                <p>Pista: Divide la autonomía total entre el consumo diario.</p>
            </div>
        </div>

        <!-- Escena 18: Eficiencia Energética -->
        <div id="scene-18" class="scene">
            <h2>Fase 18: Medidas de Eficiencia Energética</h2>
            <p>El plan de eficiencia energética necesita identificar medidas efectivas.</p>
            
            <div class="puzzle-container">
                <p>Selecciona las medidas que SÍ mejoran la eficiencia energética en edificios (6 respuestas correctas):</p>
                <div class="option-group" id="efficiency-options">
                </div>
                
                <div class="feedback-container" id="efficiency-feedback"></div>
                <button class="btn" id="efficiency-verify" onclick="checkEfficiencyAnswer()">Verificar</button>
                <button class="btn" id="efficiency-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-29')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-29">
                <p>Pista: Las medidas de eficiencia reducen el consumo energético sin disminuir el confort.</p>
            </div>
        </div>

        <!-- Escena 19: Gestión energética -->
        <div id="scene-19" class="scene">
            <h2>Fase 19: Gestión Energética Sostenible</h2>
            <p>El sistema de gestión energética de la ciudad necesita recalibrarse. Debes resolver este acertijo sobre energía renovable.</p>
            <div class="puzzle-container">
                <p>En una ciudad española, el 40% de la energía proviene de fuentes renovables. Si la ciudad consume 500 MWh diarios, ¿cuántos MWh provienen de fuentes renovables?</p>
                <input type="text" id="energy-answer" placeholder="Ingresa tu respuesta en MWh">
                <div class="feedback-container" id="energy-feedback"></div>
                <button class="btn" id="energy-verify" onclick="checkEnergyAnswer()">Verificar</button>
                <button class="btn" id="energy-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-2')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-2">
                <p>Pista: Recuerda que el porcentaje representa una parte del total.</p>
            </div>
        </div>

        <!-- Escena 20: Alumbrado Público -->
        <div id="scene-20" class="scene">
            <h2>Fase 20: Sistema de Alumbrado Público Inteligente</h2>
            <p>El sistema de alumbrado necesita ser optimizado para ahorrar energía.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas estrategias es MÁS eficiente para reducir el consumo energético del alumbrado público?</p>
                <select id="lighting-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="lighting-feedback"></div>
                <button class="btn" id="lighting-verify" onclick="checkLightingAnswer()">Verificar</button>
                <button class="btn" id="lighting-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-22')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-22">
                <p>Pista: Considera tecnologías que adapten el consumo a las necesidades reales.</p>
            </div>
        </div>

        <!-- Escena 21: Plataforma de Participación Ciudadana -->
        <div id="scene-21" class="scene">
            <h2>Fase 21: Plataforma de Participación Ciudadana</h2>
            <p>La plataforma digital de participación ciudadana necesita que clasifiques correctamente las propuestas recibidas.</p>
            
            <div class="puzzle-container">
                <p>Relaciona cada propuesta ciudadana con la categoría correcta arrastrando las tarjetas:</p>
                
                <div class="matching-game">
                    <div class="matching-column">
                        <h3>Propuestas</h3>
                        <div id="propuestas-container-9">
                        </div>
                    </div>
                    <div class="matching-column">
                        <h3>Categorías</h3>
                        <div id="categoriaA" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Movilidad sostenible</div>
                        <div id="categoriaB" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Gobierno digital</div>
                        <div id="categoriaC" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Infraestructura verde</div>
                        <div id="categoriaD" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Energía y medio ambiente</div>
                    </div>
                </div>
                
                <div class="reset-container">
                    <button class="btn-reset" onclick="resetMatchingGame(21)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Reiniciar
                    </button>
                </div>
                
                <div class="feedback-container" id="matching-feedback"></div>
                <button class="btn" id="matching-verify" onclick="checkMatchingAnswer()">Verificar</button>
                <button class="btn" id="matching-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-9')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-9">
                <p>Pista: Analiza el objetivo principal de cada propuesta para determinar su categoría.</p>
            </div>
        </div>

        <!-- Escena 22: Ciberseguridad Urbana -->
        <div id="scene-22" class="scene">
            <h2>Fase 22: Ciberseguridad Urbana</h2>
            <p>El sistema de ciberseguridad de la ciudad ha detectado intentos de intrusión. Debes identificar la amenaza.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estas NO es una práctica recomendada de ciberseguridad para sistemas de ciudad inteligente?</p>
                <div class="option-group" id="security-options">
                </div>
                <div class="feedback-container" id="security-feedback"></div>
                <button class="btn" id="security-verify" onclick="checkSecurityAnswer()">Verificar</button>
                <button class="btn" id="security-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-10')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-10">
                <p>Pista: Piensa en prácticas que aumenten el riesgo de brechas de seguridad.</p>
            </div>
        </div>

        <!-- Escena 23: Reciclaje de pilas y baterías -->
        <div id="scene-23" class="scene">
            <h2>Fase 23: Gestión de Pilas y Baterías</h2>
            <p>El sistema de recogida de pilas y baterías necesita que identifiques los puntos de reciclaje adecuados.</p>
            
            <div class="puzzle-container">
                <p>Relaciona cada tipo de pila/batería con su punto de reciclaje correcto:</p>
                
                <div class="matching-game">
                    <div class="matching-column">
                        <h3>Tipos de pilas/baterías</h3>
                        <div id="pilas-container-18">
                        </div>
                    </div>
                    <div class="matching-column">
                        <h3>Puntos de reciclaje</h3>
                        <div id="puntoA" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Contenedor específico en supermercados</div>
                        <div id="puntoB" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Taller mecánico o punto limpio</div>
                        <div id="puntoC" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Tienda de electrónica o punto limpio</div>
                        <div id="puntoD" class="matching-item" ondrop="dropMatch(event)" ondragover="allowDrop(event)">Punto limpio o tienda especializada</div>
                    </div>
                </div>
                
                <div class="reset-container">
                    <button class="btn-reset" onclick="resetMatchingGame(23)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                        </svg>
                        Reiniciar
                    </button>
                </div>
                
                <div class="feedback-container" id="pilas-feedback"></div>
                <button class="btn" id="pilas-verify" onclick="checkPilasAnswer()">Verificar</button>
                <button class="btn" id="pilas-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-18')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-18">
                <p>Pista: Considera el tamaño, toxicidad y valor de reutilización de cada tipo de pila/batería.</p>
            </div>
        </div>

        <!-- Escena 24: Reciclaje de RAEE -->
        <div id="scene-24" class="scene">
            <h2>Fase 24: Gestión de Residuos Electrónicos</h2>
            <p>El sistema de gestión de RAEE (Residuos de Aparatos Eléctricos y Electrónicos) necesita configuración.</p>
            
            <div class="puzzle-container">
                <p>Arrastra cada dispositivo electrónico al punto de recogida correcto:</p>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #9c27b0; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: white; font-weight: bold;">Punto Limpio</div>
                        <div id="punto-limpio" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #9c27b0;"></div>
                    </div>
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #ff9800; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: white; font-weight: bold;">Tienda</div>
                        <div id="tienda" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #ff9800;"></div>
                    </div>
                    <div style="text-align: center; flex: 1; min-width: 150px; margin: 10px;">
                        <div style="background: #795548; padding: 10px; border-radius: 5px; margin-bottom: 5px; color: white; font-weight: bold;">Reparación</div>
                        <div id="reparacion" class="bin" ondrop="drop(event)" ondragover="allowDrop(event)" style="border-color: #795548;"></div>
                    </div>
                </div>
                
                <div class="waste-items-container" id="waste-items-container-16">
                </div>
                
                <div class="feedback-container" id="raee-feedback"></div>
                <button class="btn" id="raee-verify" onclick="checkRaeeAnswer()" style="margin-top: 20px;">Verificar</button>
                <button class="btn" id="raee-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-16')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-16">
                <p>Pista: Punto Limpio: dispositivos grandes o muy antiguos. Tienda: al comprar uno nuevo. Reparación: si es reparable.</p>
            </div>
        </div>

        <!-- Escena 25: Conectividad 5G -->
        <div id="scene-25" class="scene">
            <h2>Fase 25: Red de Conectividad 5G</h2>
            <p>La red 5G de la ciudad tiene problemas de cobertura. Debes optimizar la ubicación de las antenas.</p>
            
            <div class="puzzle-container">
                <p>Selecciona la ubicación más adecuada para una nueva antena 5G considerando estos factores:</p>
                <select id="antenna-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="antenna-feedback"></div>
                <button class="btn" id="antenna-verify" onclick="checkAntennaAnswer()">Verificar</button>
                <button class="btn" id="antenna-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-7')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-7">
                <p>Pista: Piensa en dónde se necesita mayor capacidad de red y cobertura.</p>
            </div>
        </div>

        <!-- Escena 26: Espacios Verdes -->
        <div id="scene-26" class="scene">
            <h2>Fase 26: Gestión de Espacios Verdes Urbanos</h2>
            <p>El sistema de riego de parques y jardines necesita ser optimizado.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estos sistemas es MÁS eficiente para el riego de zonas verdes urbanas?</p>
                <select id="green-answer">
                    <option value="">Selecciona una opción</option>
                </select>
                <div class="feedback-container" id="green-feedback"></div>
                <button class="btn" id="green-verify" onclick="checkGreenAnswer()">Verificar</button>
                <button class="btn" id="green-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-24')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-24">
                <p>Pista: Considera sistemas que adapten el riego a las condiciones reales del suelo y clima.</p>
            </div>
        </div>

        <!-- Escena 27: IoT y Sensores -->
        <div id="scene-27" class="scene">
            <h2>Fase 27: Red de Sensores IoT</h2>
            <p>La red de sensores IoT de la ciudad ha detectado anomalías. Debes identificar el sensor que no pertenece al ecosistema.</p>
            
            <div class="puzzle-container">
                <p>Selecciona el sensor que NO forma parte de una red de ciudad inteligente:</p>
                <div class="option-group" id="sensor-options">
                </div>
                <div class="feedback-container" id="sensor-feedback"></div>
                <button class="btn" id="sensor-verify" onclick="checkSensorAnswer()">Verificar</button>
                <button class="btn" id="sensor-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-4')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-4">
                <p>Pista: Piensa en qué sensores se utilizan para monitorizar infraestructuras urbanas.</p>
            </div>
        </div>

        <!-- Escena 28: Compostaje Urbano -->
        <div id="scene-28" class="scene">
            <h2>Fase 28: Sistema de Compostaje Urbano</h2>
            <p>El nuevo programa de compostaje comunitario necesita identificar materiales adecuados.</p>
            
            <div class="puzzle-container">
                <p>Selecciona los materiales que SÍ pueden compostarse en un sistema de compostaje urbano (4 respuestas correctas):</p>
                <div class="option-group" id="compost-options">
                </div>
                
                <div class="feedback-container" id="compost-feedback"></div>
                <button class="btn" id="compost-verify" onclick="checkCompostAnswer()">Verificar</button>
                <button class="btn" id="compost-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-26')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-26">
                <p>Pista: Solo materiales orgánicos biodegradables pueden compostarse.</p>
            </div>
        </div>

        <!-- Escena 29: Salud Urbana -->
        <div id="scene-29" class="scene">
            <h2>Fase 29: Plataforma de Salud Urbana</h2>
            <p>El sistema de monitorización de salud pública necesita configurarse correctamente.</p>
            
            <div class="puzzle-container">
                <p>¿Cuál de estos NO es un indicador típico de salud urbana monitorizado en ciudades inteligentes?</p>
                <div class="option-group" id="health-options">
                </div>
                <div class="feedback-container" id="health-feedback"></div>
                <button class="btn" id="health-verify" onclick="checkHealthAnswer()">Verificar</button>
                <button class="btn" id="health-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-12')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-12">
                <p>Pista: Piensa en indicadores de salud pública, no datos médicos personales.</p>
            </div>
        </div>
        
        <!-- Escena 30: Código de acceso Final -->
        <div id="scene-30" class="scene">
            <h2>Fase 30: Código de Acceso Final</h2>
            <p>¡Estás cerca de restaurar varios sistemas! Solo necesitas descifrar el código basado en datos de ciudades inteligentes españolas.</p>
            
            <div class="puzzle-container">
                <p>Resuelve este acertijo para obtener el código final :</p>
                <p>En España, hay una ciudad que es líder en implementación de tecnologías smart city. Su nombre tiene 9 letras y comienza con "B". ¿Cuál es la tercera letra de esta ciudad?</p>
                <input type="text" id="city-answer" placeholder="Ingresa la tercera letra">
                <div class="feedback-container" id="city-feedback"></div>
                <button class="btn" id="city-verify" onclick="checkCityAnswer()">Verificar</button>
                <button class="btn" id="city-continue" onclick="nextSceneWithScroll()" style="display:none;">Continuar</button>
            </div>
            
            <button class="btn-hint" onclick="toggleHint('hint-15')">¿Necesitas una pista?</button>
            <div class="hint" id="hint-15">
                <p>Pista: Esta ciudad es la capital de una comunidad autónoma y es conocida por su proyecto "Smart City".</p>
            </div>
        </div>

        <!-- Escena final -->
        <div id="scene-final" class="scene">
            <div class="final-message">
                <h2>¡Felicidades!</h2>
                <p>Has logrado restaurar todos los sistemas de la ciudad inteligente.</p>
                <p>Gracias a tu experticia, la ciudad ahora funciona de manera más eficiente, sostenible y conectada.</p>
                <div class="final-time" id="final-time"></div>
                <p>Comparte tu logro con otros amantes de la tecnología urbana.</p>
                <button class="btn" onclick="restartGame()">Jugar de Nuevo</button>
            </div>
        </div>
    </div>

    <script>
        // Variables del juego
        let currentScene = 0;
        let timerInterval;
        let timeLeft;
        const total_time = 900;
        let totalScenes = 30;
        let startTime;
        let wasteAnswers = {
            yellow: [],
            green: [],
            blue: []
        };
        let raeeAnswers = {
            'punto-limpio': [],
            'tienda': [],
            'reparacion': []
        };
        let selectedOption = {
            sensor: null,
            security: null,
            tourism: null,
            health: null,
            circular: null,
            governance: null
        };
        let selectedOrganica = [];
        let selectedCompost = [];
        let selectedGarden = [];
        let selectedActive = [];
        let selectedEfficiency = [];
        let selectedBiodiversity = [];
        let matchingPairs = {};
        let planificacionOrder = {};

        // Función para reproducir sonidos con multiplicadores de volumen
        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            const volumeSlider = document.getElementById('volumeSlider');
            
            if (sound && volumeSlider) {
                sound.currentTime = 0;
                
                // 1. Obtener el volumen base del control deslizante (0-100)
                const baseVolume = parseInt(volumeSlider.value) / 100; // Convertir a 0-1
                
                // 2. Multiplicadores relativos para cada tipo de sonido
                const volumeMultipliers = {
                    'sonidoBotonJugar': 0.7,
                    'sonidoBotonContinuar': 0.9,
                    'sonidoRespuestaCorrecta': 1.0,
                    'sonidoRespuestaIncorrecta': 2.0,
                    'sonidoUrgencia': 0.5
                };
                
                // 3. Calcular volumen final con límites
                const multiplier = volumeMultipliers[soundId] || 1.0;
                let finalVolume = baseVolume * multiplier;
                
                // 4. Asegurar que no exceda 1.0 (máximo volumen permitido)
                finalVolume = Math.min(finalVolume, 1.0);
                
                // 5. Aplicar el volumen calculado
                sound.volume = finalVolume;
                
                // 6. Reproducir (con manejo de errores)
                sound.play().catch(e => {
                    console.log('Error reproduciendo sonido:', e);
                });
            }
        }

        // Iniciar el juego
        function startGame() {
            
            playSound('sonidoBotonJugar');

            currentScene = 1;
            document.getElementById('scene-intro').classList.remove('active');
            document.getElementById('scene-1').classList.add('active');
            startTime = new Date();
            startTimer();
            updateProgress();
            
            // Inicializar escenas con opciones aleatorias
            initializeRandomOptions();
            
            // Desplazar al inicio de la escena
            setTimeout(() => {
                document.getElementById(`scene-1`).scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Función para mezclar arrays
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Inicializar opciones aleatorias
        function initializeRandomOptions() {
            // Escena 3: Residuos
            const wasteItems = [
                {id: 'item1', text: 'Botella de plástico', correct: 'yellow'},
                {id: 'item2', text: 'Periódico', correct: 'blue'},
                {id: 'item3', text: 'Botella de vidrio', correct: 'green'},
                {id: 'item4', text: 'Lata de refresco', correct: 'yellow'},
                {id: 'item5', text: 'Revista', correct: 'blue'}
            ];
            shuffleArray(wasteItems);
            const wasteContainer = document.getElementById('waste-items-container-3');
            wasteContainer.innerHTML = '';
            wasteItems.forEach(item => {
                const div = document.createElement('div');
                div.id = item.id;
                div.className = 'waste-item';
                div.draggable = true;
                div.ondragstart = drag;
                div.textContent = item.text;
                wasteContainer.appendChild(div);
            });

            // Escena 4: Sensores
            const sensorOptions = [
                {text: 'Sensor de calidad del aire', correct: false},
                {text: 'Sensor de aparcamiento', correct: false},
                {text: 'Sensor de temperatura corporal', correct: true},
                {text: 'Sensor de nivel de contenedores', correct: false},
                {text: 'Sensor de tráfico', correct: false},
                {text: 'Sensor de intensidad lumínica', correct: false}
            ];
            shuffleArray(sensorOptions);
            const sensorContainer = document.getElementById('sensor-options');
            sensorContainer.innerHTML = '';
            sensorOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'sensor'); };
                div.textContent = option.text;
                sensorContainer.appendChild(div);
            });

            // Escena 7: Antena 5G
            const antennaOptions = [
                {value: 'A', text: 'Zona residencial de baja densidad', correct: false},
                {value: 'B', text: 'Centro histórico con edificios altos', correct: false},
                {value: 'C', text: 'Parque industrial con naves bajas', correct: false},
                {value: 'D', text: 'Plaza central abierta con alta afluencia', correct: true}
            ];
            shuffleArray(antennaOptions);
            const antennaSelect = document.getElementById('antenna-answer');
            antennaSelect.innerHTML = '<option value="">Selecciona una opción</option>';
            antennaOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                antennaSelect.appendChild(opt);
            });

            // Escena 9: Emparejamiento
            const propuestas9 = [
                {id: 'propuesta1', text: 'Más carriles bici protegidos', correct: 'categoriaA'},
                {id: 'propuesta2', text: 'App para reportar incidencias urbanas', correct: 'categoriaB'},
                {id: 'propuesta3', text: 'Instalación de puntos de recarga para VE', correct: 'categoriaD'},
                {id: 'propuesta4', text: 'Más zonas verdes y arbolado', correct: 'categoriaC'}
            ];
            shuffleArray(propuestas9);
            const propuestasContainer9 = document.getElementById('propuestas-container-9');
            propuestasContainer9.innerHTML = '';
            propuestas9.forEach(propuesta => {
                const div = document.createElement('div');
                div.id = propuesta.id;
                div.className = 'matching-item';
                div.draggable = true;
                div.ondragstart = dragMatch;
                div.textContent = propuesta.text;
                propuestasContainer9.appendChild(div);
            });

            // Escena 10: Ciberseguridad
            const securityOptions = [
                {text: 'Actualizaciones regulares de software', correct: false},
                {text: 'Contraseñas únicas y complejas', correct: false},
                {text: 'Compartir credenciales entre departamentos', correct: true},
                {text: 'Cifrado de datos sensibles', correct: false},
                {text: 'Copias de seguridad periódicas', correct: false}
            ];
            shuffleArray(securityOptions);
            const securityContainer = document.getElementById('security-options');
            securityContainer.innerHTML = '';
            securityOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'security'); };
                div.textContent = option.text;
                securityContainer.appendChild(div);
            });

            // Escena 11: Turismo
            const tourismOptions = [
                {text: 'Beacons para información contextual', correct: false},
                {text: 'Realidad aumentada en puntos de interés', correct: false},
                {text: 'Sensores de radiación nuclear', correct: true},
                {text: 'Apps con rutas personalizadas', correct: false},
                {text: 'Análisis de datos de afluencia', correct: false}
            ];
            shuffleArray(tourismOptions);
            const tourismContainer = document.getElementById('tourism-options');
            tourismContainer.innerHTML = '';
            tourismOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'tourism'); };
                div.textContent = option.text;
                tourismContainer.appendChild(div);
            });

            // Escena 12: Salud
            const healthOptions = [
                {text: 'Calidad del aire', correct: false},
                {text: 'Niveles de ruido', correct: false},
                {text: 'Acceso a espacios verdes', correct: false},
                {text: 'Historial médico individual', correct: true},
                {text: 'Disponibilidad de agua potable', correct: false}
            ];
            shuffleArray(healthOptions);
            const healthContainer = document.getElementById('health-options');
            healthContainer.innerHTML = '';
            healthOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'health'); };
                div.textContent = option.text;
                healthContainer.appendChild(div);
            });

            // Escena 13: Economía circular
            const circularOptions = [
                {text: 'Reciclaje de materiales', correct: false},
                {text: 'Reparación y reutilización', correct: false},
                {text: 'Vertido en un desagüe', correct: true},
                {text: 'Compartición de recursos', correct: false},
                {text: 'Diseño para la durabilidad', correct: false}
            ];
            shuffleArray(circularOptions);
            const circularContainer = document.getElementById('circular-options');
            circularContainer.innerHTML = '';
            circularOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'circular'); };
                div.textContent = option.text;
                circularContainer.appendChild(div);
            });

            // Escena 14: Gobernanza
            const governanceOptions = [
                {text: 'Transparencia', correct: false},
                {text: 'Privacidad por diseño', correct: false},
                {text: 'Venta de datos personales', correct: true},
                {text: 'Participación ciudadana', correct: false},
                {text: 'Seguridad de la información', correct: false}
            ];
            shuffleArray(governanceOptions);
            const governanceContainer = document.getElementById('governance-options');
            governanceContainer.innerHTML = '';
            governanceOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { selectOption(this, 'governance'); };
                div.textContent = option.text;
                governanceContainer.appendChild(div);
            });

            // Escena 16: RAEE
            const raeeItems = [
                {id: 'raee1', text: 'Teléfono móvil roto', correct: 'reparacion'},
                {id: 'raee2', text: 'Ordenador portátil viejo', correct: 'punto-limpio'},
                {id: 'raee3', text: 'Tablet con pantalla rota', correct: 'reparacion'},
                {id: 'raee4', text: 'Cargador de móvil', correct: 'tienda'},
                {id: 'raee5', text: 'Televisor antiguo', correct: 'punto-limpio'}
            ];
            shuffleArray(raeeItems);
            const raeeContainer = document.getElementById('waste-items-container-16');
            raeeContainer.innerHTML = '';
            raeeItems.forEach(item => {
                const div = document.createElement('div');
                div.id = item.id;
                div.className = 'waste-item';
                div.draggable = true;
                div.ondragstart = drag;
                div.textContent = item.text;
                raeeContainer.appendChild(div);
            });

            // Escena 17: Orgánica
            const organicaOptions = [
                {text: 'Restos de fruta y verdura', correct: true},
                {text: 'Papel de cocina usado', correct: true},
                {text: 'Huesos de carne', correct: true},
                {text: 'Botella de plástico', correct: false},
                {text: 'Cáscaras de huevo', correct: true},
                {text: 'Bolsas de plástico', correct: false},
                {text: 'Posos de café', correct: true},
                {text: 'Pelo y uñas', correct: true}
            ];
            shuffleArray(organicaOptions);
            const organicaContainer = document.getElementById('organica-options');
            organicaContainer.innerHTML = '';
            organicaOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'organica'); };
                div.textContent = option.text;
                organicaContainer.appendChild(div);
            });

            // Escena 18: Emparejamiento
            const pilas18 = [
                {id: 'pila1', text: 'Pilas AA/AAA', correct: 'puntoA'},
                {id: 'pila2', text: 'Batería de coche', correct: 'puntoB'},
                {id: 'pila3', text: 'Batería de móvil', correct: 'puntoC'},
                {id: 'pila4', text: 'Batería de ordenador portátil', correct: 'puntoD'}
            ];
            shuffleArray(pilas18);
            const pilasContainer18 = document.getElementById('pilas-container-18');
            pilasContainer18.innerHTML = '';
            pilas18.forEach(pila => {
                const div = document.createElement('div');
                div.id = pila.id;
                div.className = 'matching-item';
                div.draggable = true;
                div.ondragstart = dragMatch;
                div.textContent = pila.text;
                pilasContainer18.appendChild(div);
            });

            // Escena 19: Planificación
            const proyectos19 = [
                {id: 'proyecto1', text: 'Crear corredores verdes que conecten parques urbanos', correctOrder: '1'},
                {id: 'proyecto2', text: 'Implementar sistema de recogida neumática de residuos', correctOrder: '3'},
                {id: 'proyecto3', text: 'Instalar paneles solares en edificios municipales', correctOrder: '2'},
                {id: 'proyecto4', text: 'Digitalizar trámites municipales', correctOrder: '4'}
            ];
            shuffleArray(proyectos19);
            const planificacionContainer = document.getElementById('planificacion-container');
            planificacionContainer.innerHTML = '';
            
            // Inicializar orden actual
            planificacionOrder = {};
            
            proyectos19.forEach((proyecto, index) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.background = 'rgba(23, 42, 70, 0.9)';
                div.style.padding = '15px';
                div.style.borderRadius = '8px';
                div.style.marginBottom = '10px';
                
                const positionMarker = document.createElement('div');
                positionMarker.className = 'position-marker';
                positionMarker.style.marginRight = '15px';
                positionMarker.style.fontSize = '1.5rem';
                positionMarker.style.color = '#64ffda';
                positionMarker.style.minWidth = '30px';
                positionMarker.style.textAlign = 'center';
                positionMarker.style.fontWeight = 'bold';
                positionMarker.textContent = (index + 1).toString();
                
                const projectDiv = document.createElement('div');
                projectDiv.id = proyecto.id;
                projectDiv.className = 'matching-item';
                projectDiv.style.flex = '1';
                projectDiv.style.cursor = 'move';
                projectDiv.draggable = true;
                projectDiv.ondragstart = dragPlanificacion;
                projectDiv.textContent = proyecto.text;
                
                div.appendChild(positionMarker);
                div.appendChild(projectDiv);
                planificacionContainer.appendChild(div);
                
                // Guardar el orden actual basado en la posición del número
                planificacionOrder[proyecto.id] = (index + 1).toString();
            });

            // Escena 20: Emparejamiento
            const caracteristicas20 = [
                {id: 'caracteristica1', text: 'Unificación de pagos', correct: 'beneficioC'},
                {id: 'caracteristica2', text: 'Planificación de rutas multimodales', correct: 'beneficioA'},
                {id: 'caracteristica3', text: 'Información en tiempo real', correct: 'beneficioB'},
                {id: 'caracteristica4', text: 'Sistema de reservas integrado', correct: 'beneficioD'}
            ];
            shuffleArray(caracteristicas20);
            const caracteristicasContainer20 = document.getElementById('caracteristicas-container-20');
            caracteristicasContainer20.innerHTML = '';
            caracteristicas20.forEach(caracteristica => {
                const div = document.createElement('div');
                div.id = caracteristica.id;
                div.className = 'matching-item';
                div.draggable = true;
                div.ondragstart = dragMatch;
                div.textContent = caracteristica.text;
                caracteristicasContainer20.appendChild(div);
            });

            // Escena 21: Gestión del Agua
            const waterOptions = [
                {value: 'A', text: 'Sensores de presión en tiempo real', correct: true},
                {value: 'B', text: 'Inspecciones visuales anuales', correct: false},
                {value: 'C', text: 'Encuestas a usuarios', correct: false},
                {value: 'D', text: 'Análisis químico mensual del agua', correct: false}
            ];
            shuffleArray(waterOptions);
            const waterSelect = document.getElementById('water-answer');
            waterSelect.innerHTML = '<option value="">Selecciona una opción</option>';
            waterOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                waterSelect.appendChild(opt);
            });

            // Escena 22: Alumbrado Público
            const lightingOptions = [
                {value: 'A', text: 'LEDs con regulación inteligente según tráfico y condiciones ambientales', correct: true},
                {value: 'B', text: 'Lámparas de sodio de alta presión programadas con horario fijo', correct: false},
                {value: 'C', text: 'Halógenos con sensores de movimiento básicos', correct: false},
                {value: 'D', text: 'Fluorescentes con interruptores manuales', correct: false}
            ];
            shuffleArray(lightingOptions);
            const lightingSelect = document.getElementById('lighting-answer');
            lightingSelect.innerHTML = '<option value="">Selecciona una opción</option>';
            lightingOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                lightingSelect.appendChild(opt);
            });

            // Escena 23: Movilidad Sostenible
            const mobilityOptions = [
                {value: 'A', text: 'Zona de bajas emisiones con transporte público frecuente y carriles bici protegidos', correct: true},
                {value: 'B', text: 'Campañas publicitarias sobre conducción eficiente', correct: false},
                {value: 'C', text: 'Aparcamientos disuasorios en las afueras sin conexión directa al centro', correct: false},
                {value: 'D', text: 'Peatonalización parcial los domingos por la mañana', correct: false}
            ];
            shuffleArray(mobilityOptions);
            const mobilitySelect = document.getElementById('mobility-answer');
            mobilitySelect.innerHTML = '<option value="">Selecciona una opción</option>';
            mobilityOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                mobilitySelect.appendChild(opt);
            });

            // Escena 24: Espacios Verdes
            const greenOptions = [
                {value: 'A', text: 'Riego por goteo con sensores de humedad del suelo y previsión meteorológica', correct: true},
                {value: 'B', text: 'Aspersores programados por horario fijo', correct: false},
                {value: 'C', text: 'Riego manual según disponibilidad del personal', correct: false},
                {value: 'D', text: 'Mangueras con temporizadores básicos', correct: false}
            ];
            shuffleArray(greenOptions);
            const greenSelect = document.getElementById('green-answer');
            greenSelect.innerHTML = '<option value="">Selecciona una opción</option>';
            greenOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                greenSelect.appendChild(opt);
            });

            // Escena 25: Energías Renovables
            const solarOptions = [
                {value: 'A', text: 'Cubiertas de naves industriales en polígonos', correct: true},
                {value: 'B', text: 'Zonas boscosas protegidas', correct: false},
                {value: 'C', text: 'Centro histórico con edificios catalogados', correct: false},
                {value: 'D', text: 'Humerales con alta biodiversidad', correct: false}
            ];
            shuffleArray(solarOptions);
            const solarSelect = document.getElementById('solar-answer');
            solarSelect.innerHTML = '<option value="">Selecciona una opción</option>';
            solarOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option.value;
                opt.textContent = option.text;
                solarSelect.appendChild(opt);
            });
            
            // Escena 26: Compostaje
            const compostOptions = [
                {text: 'Restos de poda de jardín', correct: true},
                {text: 'Cenizas de carbón', correct: false},
                {text: 'Cartón sin tintas tóxicas', correct: true},
                {text: 'Productos lácteos', correct: false},
                {text: 'Cáscaras de frutos secos', correct: true},
                {text: 'Aceite de cocina usado', correct: false},
                {text: 'Hojas secas', correct: true},
                {text: 'Carne y pescado', correct: false}
            ];
            shuffleArray(compostOptions);
            const compostContainer = document.getElementById('compost-options');
            compostContainer.innerHTML = '';
            compostOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'compost'); };
                div.textContent = option.text;
                compostContainer.appendChild(div);
            });

            // Escena 27: Huertos Urbanos
            const gardenOptions = [
                {text: 'Rotación de cultivos', correct: true},
                {text: 'Uso exclusivo de pesticidas químicos', correct: false},
                {text: 'Asociación de plantas compatibles', correct: true},
                {text: 'Riego con agua potable sin recoger agua de lluvia', correct: false},
                {text: 'Compostaje in situ de restos vegetales', correct: true},
                {text: 'Monocultivo intensivo', correct: false},
                {text: 'Control biológico de plagas', correct: true},
                {text: 'Uso de plantas autóctonas', correct: true}
            ];
            shuffleArray(gardenOptions);
            const gardenContainer = document.getElementById('garden-options');
            gardenContainer.innerHTML = '';
            gardenOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'garden'); };
                div.textContent = option.text;
                gardenContainer.appendChild(div);
            });

            // Escena 28: Movilidad Activa
            const activeOptions = [
                {text: 'Carriles bici segregados del tráfico', correct: true},
                {text: 'Aceras estrechas y obstruidas', correct: false},
                {text: 'Pasos de peatones elevados', correct: true},
                {text: 'Calles sin semáforos peatonales', correct: false},
                {text: 'Zonas 30 con prioridad peatonal', correct: true},
                {text: 'Aparcamiento en aceras', correct: false},
                {text: 'Señalización clara para ciclistas', correct: true},
                {text: 'Cruces peatonales muy separados', correct: false}
            ];
            shuffleArray(activeOptions);
            const activeContainer = document.getElementById('active-options');
            activeContainer.innerHTML = '';
            activeOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'active'); };
                div.textContent = option.text;
                activeContainer.appendChild(div);
            });

            // Escena 29: Eficiencia Energética
            const efficiencyOptions = [
                {text: 'Aislamiento térmico en fachadas y cubiertas', correct: true},
                {text: 'Ventanas de doble acristalamiento', correct: true},
                {text: 'Sistemas de calefacción eléctrica por resistencia', correct: false},
                {text: 'Ventilación natural cruzada', correct: true},
                {text: 'Iluminación LED con sensores de presencia', correct: true},
                {text: 'Mantenimiento de equipos obsoletos', correct: false},
                {text: 'Orientación optimizada para ganancia solar pasiva', correct: true},
                {text: 'Electrodomésticos de alta eficiencia energética', correct: true}
            ];
            shuffleArray(efficiencyOptions);
            const efficiencyContainer = document.getElementById('efficiency-options');
            efficiencyContainer.innerHTML = '';
            efficiencyOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'efficiency'); };
                div.textContent = option.text;
                efficiencyContainer.appendChild(div);
            });

            // Escena 30: Biodiversidad Urbana
            const biodiversityOptions = [
                {text: 'Hoteles de insectos', correct: true},
                {text: 'Césped intensivo con corte frecuente', correct: false},
                {text: 'Setos con especies autóctonas', correct: true},
                {text: 'Pavimentación completa de solares', correct: false},
                {text: 'Charcas para anfibios', correct: true},
                {text: 'Uso exclusivo de especies exóticas ornamentales', correct: false},
                {text: 'Corredores verdes entre espacios naturales', correct: true},
                {text: 'Nidales para aves y murciélagos', correct: true}
            ];
            shuffleArray(biodiversityOptions);
            const biodiversityContainer = document.getElementById('biodiversity-options');
            biodiversityContainer.innerHTML = '';
            biodiversityOptions.forEach(option => {
                const div = document.createElement('div');
                div.className = 'option';
                div.onclick = function() { toggleSelection(this, 'biodiversity'); };
                div.textContent = option.text;
                biodiversityContainer.appendChild(div);
            });
        }

        // Temporizador
        function startTimer() {
            timeLeft = total_time;
            updateTimerDisplay();
            
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGameByTime();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const seconds = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('timer').textContent = `Tiempo: ${minutes}:${seconds}`;
            
            // Cambiar color cuando queden 10 segundos o menos
            if (timeLeft <= 10) {
                document.getElementById('timer').style.color = '#ff6b6b';
                document.getElementById('timer').style.animation = 'pulse 0.5s infinite';
                // Reproducir sonido de urgencia cuando llega a 10 segundos
                if (timeLeft === 10) {
                    playSound('sonidoUrgencia');
                }
            } else {
                document.getElementById('timer').style.color = '#e6f1ff';
                document.getElementById('timer').style.animation = 'none';
            }
        }

        function endGameByTime() {
            // Calcular pruebas completadas
            const completedTests = currentScene - 1;
            
            // Ocultar todas las escenas
            document.querySelectorAll('.scene').forEach(scene => {
                scene.classList.remove('active');
            });
            
            // Mostrar escena final con resultados
            document.getElementById('scene-final').classList.add('active');
            
            // Actualizar el mensaje final
            const finalMessage = document.querySelector('.final-message');
            finalMessage.innerHTML = `
                <h2>¡Tiempo Agotado!</h2>
                <p>El tiempo de ${total_time} segundos ha terminado.</p>
                <p>Has completado <strong>${completedTests}</strong> de ${totalScenes} pruebas.</p>
                <div class="final-time">Pruebas superadas: ${completedTests}/${totalScenes}</div>
                <p>¡Inténtalo de nuevo para mejorar tu puntuación!</p>
                <button class="btn" onclick="restartGame()">Jugar de Nuevo</button>
            `;
            
            // Desplazar a la escena final
            setTimeout(() => {
                document.getElementById('scene-final').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const progress = (currentScene / totalScenes) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        // Avanzar a la siguiente escena
        function nextSceneWithScroll() {

            playSound('sonidoBotonContinuar');

            if (timeLeft <= 0) {
                return;
            }
            document.getElementById(`scene-${currentScene}`).classList.remove('active');
            currentScene++;

            // Limpiar MatchingPairs al cambiar de escena
            matchingPairs = {};
            
            if (currentScene <= totalScenes) {
                document.getElementById(`scene-${currentScene}`).classList.add('active');
                updateProgress();
                // Ocultar todas las pistas al cambiar de escena
                document.querySelectorAll('.hint').forEach(hint => {
                    hint.style.display = 'none';
                });
                
                // Desplazar al inicio de la nueva escena
                setTimeout(() => {
                    document.getElementById(`scene-${currentScene}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            } else {
                // Juego completado
                document.getElementById('scene-final').classList.add('active');
                const now = new Date();
                const elapsed = new Date(now - startTime);
                const minutes = elapsed.getMinutes().toString().padStart(2, '0');
                const seconds = elapsed.getSeconds().toString().padStart(2, '0');
                document.getElementById('final-time').textContent = `Tiempo total: ${minutes}:${seconds}`;
                clearInterval(timerInterval);
                
                // Desplazar a la escena final
                setTimeout(() => {
                    document.getElementById('scene-final').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);
            }
        }

        // Mostrar/ocultar pista
        function toggleHint(hintId) {
            const hint = document.getElementById(hintId);
            hint.style.display = hint.style.display === 'block' ? 'none' : 'block';
        }

        // Mostrar botón continuar y desplazar pantalla
        function showContinueButton(sceneNumber) {
            document.getElementById(`${sceneNumber}-verify`).style.display = 'none';
            document.getElementById(`${sceneNumber}-continue`).style.display = 'inline-block';
            
            // Desplazar pantalla hacia el feedback
            const feedbackElement = document.getElementById(`${sceneNumber}-feedback`);
            feedbackElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Funciones para el puzzle de arrastrar
        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function drop(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            // Solo permitir soltar en contenedores
            if (ev.target.classList.contains('bin')) {
                ev.target.appendChild(draggedElement);
                
                // Actualizar respuestas según la escena
                const binId = ev.target.id;
                const itemId = draggedElement.id;
                
                if (currentScene === 9) {
                    // Limpiar de otros contenedores
                    Object.keys(wasteAnswers).forEach(color => {
                        const index = wasteAnswers[color].indexOf(itemId);
                        if (index > -1) {
                            wasteAnswers[color].splice(index, 1);
                        }
                    });
                    
                    // Añadir al contenedor actual
                    if (binId === 'yellow-bin') wasteAnswers.yellow.push(itemId);
                    if (binId === 'green-bin') wasteAnswers.green.push(itemId);
                    if (binId === 'blue-bin') wasteAnswers.blue.push(itemId);
                } else if (currentScene === 24) {
                    // Limpiar de otros contenedores
                    Object.keys(raeeAnswers).forEach(tipo => {
                        const index = raeeAnswers[tipo].indexOf(itemId);
                        if (index > -1) {
                            raeeAnswers[tipo].splice(index, 1);
                        }
                    });
                    
                    // Añadir al contenedor actual
                    raeeAnswers[binId].push(itemId);
                }
            }
        }

        // Funciones para el juego de emparejamiento
        function dragMatch(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function dropMatch(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            const targetElement = ev.target;
            
            if (targetElement.classList.contains('matching-item') && 
                !targetElement.id.startsWith(data.substring(0, 3))) {
                
                // Guardar el emparejamiento
                matchingPairs[draggedElement.id] = targetElement.id;
                
                // Mostrar visualmente el emparejamiento
                targetElement.textContent += ` ← ${draggedElement.textContent}`;
                targetElement.classList.add('matched');
                draggedElement.style.display = 'none';
            }
        }

        // Funciones para la planificación
        function dragPlanificacion(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
        }

        function allowDropPlanificacion(ev) {
            ev.preventDefault();
        }

        function dropPlanificacion(ev) {
            ev.preventDefault();
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            
            // Encontrar el contenedor objetivo
            let targetElement = ev.target;
            while (targetElement && !targetElement.classList.contains('matching-item') && targetElement.id !== 'planificacion-container') {
                targetElement = targetElement.parentElement;
            }
            
            // Si el objetivo es un elemento de proyecto y no es el mismo que el arrastrado
            if (targetElement && targetElement.classList.contains('matching-item') && targetElement !== draggedElement) {
                // Intercambiar solo el texto entre los dos elementos
                const tempText = draggedElement.textContent;
                draggedElement.textContent = targetElement.textContent;
                targetElement.textContent = tempText;
                
                // Los números permanecen fijos, intercambiar el contenido
                const draggedId = draggedElement.id;
                const targetId = targetElement.id;
                
                // Intercambiar los IDs temporalmente para mantener la lógica
                const tempId = draggedElement.id;
                draggedElement.id = targetElement.id;
                targetElement.id = tempId;
                
                // Actualizar el orden basado en la posición visual
                const allProjects = document.querySelectorAll('#planificacion-container .matching-item');
                allProjects.forEach((project, index) => {
                    planificacionOrder[project.id] = (index + 1).toString();
                });
            }
        }

        // Seleccionar opción en preguntas de opción múltiple
        function selectOption(element, type) {
            // Deseleccionar otras opciones del mismo tipo
            document.querySelectorAll(`.option[data-type="${type}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar la nueva opción
            element.classList.add('selected');
            element.setAttribute('data-type', type);
            selectedOption[type] = element.textContent;
        }

        // Alternar selección para preguntas de múltiple selección
        function toggleSelection(element, type) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                const index = getSelectedArray(type).indexOf(element.textContent);
                if (index > -1) {
                    getSelectedArray(type).splice(index, 1);
                }
            } else {
                element.classList.add('selected');
                getSelectedArray(type).push(element.textContent);
            }
        }

        // Obtener el array de selección correspondiente
        function getSelectedArray(type) {
            switch(type) {
                case 'organica': return selectedOrganica;
                case 'compost': return selectedCompost;
                case 'garden': return selectedGarden;
                case 'active': return selectedActive;
                case 'efficiency': return selectedEfficiency;
                case 'biodiversity': return selectedBiodiversity;
                default: return [];
            }
        }

        // FUNCIONES DE VERIFICACIÓN DE RESPUESTAS

        function checkTransportAnswer() {
            const answer = document.getElementById('transport-answer').value.trim();
            const feedback = document.getElementById('transport-feedback');
            
            if (answer === '64') {
                feedback.innerHTML = '<div class="success">¡Correcto! El patrón es multiplicar por 2 cada vez.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('transport');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Intenta nuevamente.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkEnergyAnswer() {
            const answer = document.getElementById('energy-answer').value.trim();
            const feedback = document.getElementById('energy-feedback');
            
            if (answer === '200') {
                feedback.innerHTML = '<div class="success">¡Correcto! 40% de 500 MWh es 200 MWh.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('energy');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Recuerda: porcentaje × total / 100.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkWasteAnswer() {
            if (currentScene !== 9) return;

            const feedback = document.getElementById('waste-feedback');
            const correctAnswers = {
                yellow: ['item1', 'item4'],
                green: ['item3'],
                blue: ['item2', 'item5']
            };
            
            let correct = true;
            Object.keys(correctAnswers).forEach(color => {
                if (wasteAnswers[color].length !== correctAnswers[color].length || 
                    !correctAnswers[color].every(item => wasteAnswers[color].includes(item))) {
                    correct = false;
                }
            });
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has clasificado correctamente los residuos.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('waste');
            } else {
                feedback.innerHTML = '<div class="error">Clasificación incorrecta. Revisa en qué contenedor va cada residuo.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkSensorAnswer() {
            const feedback = document.getElementById('sensor-feedback');
            if (selectedOption.sensor === 'Sensor de temperatura corporal') {
                feedback.innerHTML = '<div class="success">¡Correcto! El sensor de temperatura corporal no se utiliza en redes de ciudad inteligente.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('sensor');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en qué sensores se utilizan para monitorizar infraestructuras urbanas.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkEvAnswer() {
            const answer = document.getElementById('ev-answer').value.trim();
            const feedback = document.getElementById('ev-feedback');
            
            if (answer === '6' || answer === '6.67' || answer === '7') {
                feedback.innerHTML = '<div class="success">¡Correcto! 300 km / 45 km/día ≈ 6.67 días.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('ev');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Divide la autonomía total entre el consumo diario.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkDataAnswer() {
            const answer = document.getElementById('data-answer').value.trim();
            const feedback = document.getElementById('data-feedback');
            
            if (answer === '150') {
                feedback.innerHTML = '<div class="success">¡Correcto! (125+180+95+210+140)/5 = 150 MWh.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('data');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Calcula la suma de todos los valores y divide entre 5.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkAntennaAnswer() {
            const answer = document.getElementById('antenna-answer').value;
            const feedback = document.getElementById('antenna-feedback');
            
            if (answer === 'D') {
                feedback.innerHTML = '<div class="success">¡Correcto! La plaza central con alta afluencia necesita mayor capacidad de red.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('antenna');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en dónde se necesita mayor capacidad de red.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkBuildingAnswer() {
            const answer = document.getElementById('building-answer').value.trim();
            const feedback = document.getElementById('building-feedback');
            
            if (answer === '1700') {
                feedback.innerHTML = '<div class="success">¡Correcto! 2000 kWh - 15% = 1700 kWh.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('building');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Calcula el 15% de 2000 y réstalo.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkMatchingAnswer() {
            const feedback = document.getElementById('matching-feedback');
            let correctPairs = {};
            
            if (currentScene === 21) {
                correctPairs = {
                    'propuesta1': 'categoriaA',
                    'propuesta2': 'categoriaB',
                    'propuesta3': 'categoriaD',
                    'propuesta4': 'categoriaC'
                };
            } else if (currentScene === 23) {
                correctPairs = {
                    'pila1': 'puntoA',
                    'pila2': 'puntoB',
                    'pila3': 'puntoC',
                    'pila4': 'puntoD'
                };
            } else if (currentScene === 2) {
                correctPairs = {
                    'caracteristica1': 'beneficioC',
                    'caracteristica2': 'beneficioA',
                    'caracteristica3': 'beneficioB',
                    'caracteristica4': 'beneficioD'
                };
            }
            
            let correct = true;
            for (const [item, target] of Object.entries(correctPairs)) {
                if (matchingPairs[item] !== target) {
                    correct = false;
                    break;
                }
            }
            
            if (correct && Object.keys(matchingPairs).length === Object.keys(correctPairs).length) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has relacionado correctamente todos los elementos.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('matching');
            } else {
                feedback.innerHTML = '<div class="error">Emparejamientos incorrectos o incompletos. Intenta nuevamente.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkSecurityAnswer() {
            const feedback = document.getElementById('security-feedback');
            if (selectedOption.security === 'Compartir credenciales entre departamentos') {
                feedback.innerHTML = '<div class="success">¡Correcto! Compartir credenciales aumenta el riesgo de brechas de seguridad.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('security');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en prácticas que aumenten el riesgo de seguridad.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkTourismAnswer() {
            const feedback = document.getElementById('tourism-feedback');
            if (selectedOption.tourism === 'Sensores de radiación nuclear') {
                feedback.innerHTML = '<div class="success">¡Correcto! Los sensores de radiación nuclear no son relevantes para el turismo inteligente.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('tourism');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en tecnologías relevantes para la experiencia turística.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkHealthAnswer() {
            const feedback = document.getElementById('health-feedback');
            if (selectedOption.health === 'Historial médico individual') {
                feedback.innerHTML = '<div class="success">¡Correcto! El historial médico individual no es un indicador de salud urbana.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('health');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en indicadores de salud pública, no datos médicos personales.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkCircularAnswer() {
            const feedback = document.getElementById('circular-feedback');
            if (selectedOption.circular === 'Vertido en un desagüe') {
                feedback.innerHTML = '<div class="success">¡Correcto! El vertido en un desagüe es contrario a los principios de economía circular.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('circular');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. La economía circular busca eliminar los residuos.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkGovernanceAnswer() {
            const feedback = document.getElementById('governance-feedback');
            if (selectedOption.governance === 'Venta de datos personales') {
                feedback.innerHTML = '<div class="success">¡Correcto! La venta de datos personales viola principios éticos de gobernanza.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('governance');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en prácticas que respeten los derechos de los ciudadanos.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkCityAnswer() {
            const answer = document.getElementById('city-answer').value.trim().toLowerCase();
            const feedback = document.getElementById('city-feedback');
            
            if (answer === 'r') {
                feedback.innerHTML = '<div class="success">¡Correcto! La ciudad es Barcelona. Has descifrado el código final.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('city');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. La tercera letra de Barcelona es "r".</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkRaeeAnswer() {
            if (currentScene !== 24) return;

            const feedback = document.getElementById('raee-feedback');
            const correctAnswers = {
                'punto-limpio': ['raee2', 'raee5'],
                'tienda': ['raee4'],
                'reparacion': ['raee1', 'raee3']
            };
            
            let correct = true;
            Object.keys(correctAnswers).forEach(tipo => {
                if (raeeAnswers[tipo].length !== correctAnswers[tipo].length || 
                    !correctAnswers[tipo].every(item => raeeAnswers[tipo].includes(item))) {
                    correct = false;
                }
            });
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has gestionado correctamente los residuos electrónicos.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('raee');
            } else {
                feedback.innerHTML = '<div class="error">Clasificación incorrecta. Revisa dónde debe ir cada dispositivo.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkOrganicaAnswer() {
            const feedback = document.getElementById('organica-feedback');
            const correctAnswers = [
                'Restos de fruta y verdura',
                'Papel de cocina usado',
                'Huesos de carne',
                'Cáscaras de huevo',
                'Posos de café',
                'Pelo y uñas'
            ];
            
            let correct = checkMultipleSelection(selectedOrganica, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente los residuos orgánicos.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('organica');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué materiales son compostables.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkPilasAnswer() {
            const feedback = document.getElementById('pilas-feedback');
            const correctPairs = {
                'pila1': 'puntoA',
                'pila2': 'puntoB',
                'pila3': 'puntoC',
                'pila4': 'puntoD'
            };
            
            // Verificación más específica
            let correct = true;
            for (const [item, target] of Object.entries(correctPairs)) {
                if (matchingPairs[item] !== target) {
                    correct = false;
                    break;
                }
            }
            
            // Solo verificar que hay exactamente los 4 pares
            const relevantPairs = Object.keys(matchingPairs).filter(key => key.startsWith('pila'));
            const hasAllPairs = relevantPairs.length === Object.keys(correctPairs).length;
            
            if (correct && hasAllPairs) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente los puntos de reciclaje.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('pilas');
            } else {
                feedback.innerHTML = '<div class="error">Emparejamientos incorrectos o incompletos. Intenta nuevamente.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkPlanificacionAnswer() {
            const feedback = document.getElementById('planificacion-feedback');
            const correctOrder = {
                'proyecto1': '1',
                'proyecto3': '2',
                'proyecto2': '3',
                'proyecto4': '4'
            };
            
            let correct = true;
            for (const [proyecto, orden] of Object.entries(correctOrder)) {
                if (planificacionOrder[proyecto] !== orden) {
                    correct = false;
                    break;
                }
            }
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has priorizado correctamente los proyectos.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('planificacion');
            } else {
                feedback.innerHTML = '<div class="error">Orden incorrecto. Revisa la prioridad de cada proyecto.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkMaasAnswer() {
            const feedback = document.getElementById('maas-feedback');
            const correctPairs = {
                'caracteristica1': 'beneficioC',
                'caracteristica2': 'beneficioA', 
                'caracteristica3': 'beneficioB',
                'caracteristica4': 'beneficioD'
            };
            
            // Verificación más específica
            let correct = true;
            for (const [item, target] of Object.entries(correctPairs)) {
                if (matchingPairs[item] !== target) {
                    correct = false;
                    break;
                }
            }
            
            // Solo verificar que hay exactamente los 4 pares
            const relevantPairs = Object.keys(matchingPairs).filter(key => key.startsWith('caracteristica'));
            const hasAllPairs = relevantPairs.length === Object.keys(correctPairs).length;
            
            if (correct && hasAllPairs) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has relacionado correctamente las características con sus beneficios.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('maas');
            } else {
                feedback.innerHTML = '<div class="error">Emparejamientos incorrectos o incompletos. Intenta nuevamente.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkWaterAnswer() {
            const answer = document.getElementById('water-answer').value;
            const feedback = document.getElementById('water-feedback');
            if (answer === 'A') {
                feedback.innerHTML = '<div class="success">¡Correcto! Los sensores de presión permiten detectar fugas inmediatamente.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('water');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en tecnologías que permitan detección temprana.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkLightingAnswer() {
            const answer = document.getElementById('lighting-answer').value;
            const feedback = document.getElementById('lighting-feedback');
            if (answer === 'A') {
                feedback.innerHTML = '<div class="success">¡Correcto! Los LEDs con regulación inteligente adaptan el consumo a las necesidades reales.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('lighting');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Considera sistemas que adapten el consumo automáticamente.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkMobilityAnswer() {
            const answer = document.getElementById('mobility-answer').value;
            const feedback = document.getElementById('mobility-feedback');
            if (answer === 'A') {
                feedback.innerHTML = '<div class="success">¡Correcto! La combinación de restricciones y alternativas atractivas es más efectiva.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('mobility');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en medidas que ofrezcan alternativas reales al coche.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkGreenAnswer() {
            const answer = document.getElementById('green-answer').value;
            const feedback = document.getElementById('green-feedback');
            if (answer === 'A') {
                feedback.innerHTML = '<div class="success">¡Correcto! El riego por goteo con sensores optimiza el uso del agua.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('green');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Considera sistemas que adapten el riego a las condiciones reales.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkSolarAnswer() {
            const answer = document.getElementById('solar-answer').value;
            const feedback = document.getElementById('solar-feedback');
            if (answer === 'A') {
                feedback.innerHTML = '<div class="success">¡Correcto! Las cubiertas industriales ofrecen gran superficie sin ocupar suelo adicional.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('solar');
            } else {
                feedback.innerHTML = '<div class="error">Incorrecto. Piensa en ubicaciones con máxima exposición solar y mínimo impacto.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkCompostAnswer() {
            const feedback = document.getElementById('compost-feedback');
            const correctAnswers = [
                'Restos de poda de jardín',
                'Cartón sin tintas tóxicas',
                'Cáscaras de frutos secos',
                'Hojas secas'
            ];
            
            let correct = checkMultipleSelection(selectedCompost, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente los materiales compostables.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('compost');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué materiales pueden compostarse.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkGardenAnswer() {
            const feedback = document.getElementById('garden-feedback');
            const correctAnswers = [
                'Rotación de cultivos',
                'Asociación de plantas compatibles',
                'Compostaje in situ de restos vegetales',
                'Control biológico de plagas',
                'Uso de plantas autóctonas'
            ];
            
            let correct = checkMultipleSelection(selectedGarden, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente las prácticas sostenibles.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('garden');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué prácticas son realmente sostenibles.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkActiveAnswer() {
            const feedback = document.getElementById('active-feedback');
            const correctAnswers = [
                'Carriles bici segregados del tráfico',
                'Pasos de peatones elevados',
                'Zonas 30 con prioridad peatonal',
                'Señalización clara para ciclistas'
            ];
            
            let correct = checkMultipleSelection(selectedActive, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente las infraestructuras que fomentan la movilidad activa.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('active');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué infraestructuras hacen más seguros los desplazamientos activos.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkEfficiencyAnswer() {
            const feedback = document.getElementById('efficiency-feedback');
            const correctAnswers = [
                'Aislamiento térmico en fachadas y cubiertas',
                'Ventanas de doble acristalamiento',
                'Ventilación natural cruzada',
                'Iluminación LED con sensores de presencia',
                'Orientación optimizada para ganancia solar pasiva',
                'Electrodomésticos de alta eficiencia energética'
            ];
            
            let correct = checkMultipleSelection(selectedEfficiency, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente las medidas de eficiencia energética.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('efficiency');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué medidas reducen realmente el consumo energético.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        function checkBiodiversityAnswer() {
            const feedback = document.getElementById('biodiversity-feedback');
            const correctAnswers = [
                'Hoteles de insectos',
                'Setos con especies autóctonas',
                'Charcas para anfibios',
                'Corredores verdes entre espacios naturales',
                'Nidales para aves y murciélagos'
            ];
            
            let correct = checkMultipleSelection(selectedBiodiversity, correctAnswers);
            
            if (correct) {
                feedback.innerHTML = '<div class="success">¡Correcto! Has identificado correctamente las acciones que fomentan la biodiversidad.</div>';
                playSound('sonidoRespuestaCorrecta');
                showContinueButton('biodiversity');
            } else {
                feedback.innerHTML = '<div class="error">Selección incorrecta. Revisa qué acciones crean habitats para la fauna urbana.</div>';
                playSound('sonidoRespuestaIncorrecta');
            }
        }

        // Función para verificar selecciones múltiples
        function checkMultipleSelection(selected, correctAnswers) {
            if (selected.length !== correctAnswers.length) {
                return false;
            }
            
            for (let answer of correctAnswers) {
                if (!selected.includes(answer)) {
                    return false;
                }
            }
            
            return true;
        }

        // Funciones de reinicio
        function resetMatchingGame(sceneNumber) {
            matchingPairs = {};
            
            if (sceneNumber === 21) {
                document.querySelectorAll('#scene-21 .matching-item').forEach(item => {
                    item.classList.remove('matched');
                    item.style.display = 'block';
                    if (item.id === 'categoriaA') item.textContent = 'Movilidad sostenible';
                    if (item.id === 'categoriaB') item.textContent = 'Gobierno digital';
                    if (item.id === 'categoriaC') item.textContent = 'Infraestructura verde';
                    if (item.id === 'categoriaD') item.textContent = 'Energía y medio ambiente';
                });
            } else if (sceneNumber === 23) {
                document.querySelectorAll('#scene-23 .matching-item').forEach(item => {
                    item.classList.remove('matched');
                    item.style.display = 'block';
                    if (item.id === 'puntoA') item.textContent = 'Contenedor específico en supermercados';
                    if (item.id === 'puntoB') item.textContent = 'Taller mecánico o punto limpio';
                    if (item.id === 'puntoC') item.textContent = 'Tienda de electrónica o punto limpio';
                    if (item.id === 'puntoD') item.textContent = 'Punto limpio o tienda especializada';
                });
            } else if (sceneNumber === 2) {
                document.querySelectorAll('#scene-2 .matching-item').forEach(item => {
                    item.classList.remove('matched');
                    item.style.display = 'block';
                    if (item.id === 'beneficioA') item.textContent = 'Facilita el uso combinado de transporte público y privado';
                    if (item.id === 'beneficioB') item.textContent = 'Permite optimizar tiempos de viaje';
                    if (item.id === 'beneficioC') item.textContent = 'Elimina la necesidad de múltiples apps y suscripciones';
                    if (item.id === 'beneficioD') item.textContent = 'Garantiza disponibilidad de medios de transporte';
                });
            }
            
            document.getElementById(`${getScenePrefix(sceneNumber)}-feedback`).innerHTML = '';
            document.getElementById(`${getScenePrefix(sceneNumber)}-verify`).style.display = 'inline-block';
            document.getElementById(`${getScenePrefix(sceneNumber)}-continue`).style.display = 'none';
        }

        function resetPlanificacion() {
            const proyectos19 = [
                {id: 'proyecto1', text: 'Crear corredores verdes que conecten parques urbanos', correctOrder: '1'},
                {id: 'proyecto2', text: 'Implementar sistema de recogida neumática de residuos', correctOrder: '3'},
                {id: 'proyecto3', text: 'Instalar paneles solares en edificios municipales', correctOrder: '2'},
                {id: 'proyecto4', text: 'Digitalizar trámites municipales', correctOrder: '4'}
            ];
            shuffleArray(proyectos19);
            const planificacionContainer = document.getElementById('planificacion-container');
            planificacionContainer.innerHTML = '';
            
            planificacionOrder = {};
            
            proyectos19.forEach((proyecto, index) => {
                const div = document.createElement('div');
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.background = 'rgba(23, 42, 70, 0.9)';
                div.style.padding = '15px';
                div.style.borderRadius = '8px';
                div.style.marginBottom = '10px';
                
                const positionMarker = document.createElement('div');
                positionMarker.className = 'position-marker';
                positionMarker.style.marginRight = '15px';
                positionMarker.style.fontSize = '1.5rem';
                positionMarker.style.color = '#64ffda';
                positionMarker.style.minWidth = '30px';
                positionMarker.style.textAlign = 'center';
                positionMarker.style.fontWeight = 'bold';
                positionMarker.textContent = (index + 1).toString();
                
                const projectDiv = document.createElement('div');
                projectDiv.id = proyecto.id;
                projectDiv.className = 'matching-item';
                projectDiv.style.flex = '1';
                projectDiv.style.cursor = 'move';
                projectDiv.draggable = true;
                projectDiv.ondragstart = dragPlanificacion;
                projectDiv.textContent = proyecto.text;
                
                div.appendChild(positionMarker);
                div.appendChild(projectDiv);
                planificacionContainer.appendChild(div);
                
                planificacionOrder[proyecto.id] = (index + 1).toString();
            });
            
            document.getElementById('planificacion-feedback').innerHTML = '';
            document.getElementById('planificacion-verify').style.display = 'inline-block';
            document.getElementById('planificacion-continue').style.display = 'none';
        }

        function getScenePrefix(sceneNumber) {
            switch(sceneNumber) {
                case 21: return 'matching';
                case 23: return 'pilas';
                case 2: return 'maas';
                default: return 'matching';
            }
        }

        // Reiniciar juego completo
        function restartGame() {
            
            playSound('sonidoBotonJugar');

            // Detener el temporizador si está corriendo
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            // Restaurar el color del temporizador
            document.getElementById('timer').style.color = '#e6f1ff';
            document.getElementById('timer').style.animation = 'none';
            currentScene = 0;
            wasteAnswers = { yellow: [], green: [], blue: [] };
            raeeAnswers = { 'punto-limpio': [], 'tienda': [], 'reparacion': [] };
            selectedOption = {
                sensor: null, security: null, tourism: null, health: null, circular: null, governance: null
            };
            selectedOrganica = [];
            selectedCompost = [];
            selectedGarden = [];
            selectedActive = [];
            selectedEfficiency = [];
            selectedBiodiversity = [];
            matchingPairs = {};
            planificacionOrder = {};
            
            document.querySelectorAll('.scene').forEach(scene => {
                scene.classList.remove('active');
            });
            
            document.getElementById('scene-intro').classList.add('active');
            document.querySelectorAll('input, select').forEach(input => {
                input.value = '';
            });
            document.querySelectorAll('.bin').forEach(bin => {
                bin.innerHTML = '';
            });
            document.querySelectorAll('.selected').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelectorAll('.matching-item').forEach(item => {
                item.classList.remove('matched');
                item.style.display = 'block';
            });
            document.querySelectorAll('[id$="feedback"]').forEach(el => {
                el.innerHTML = '';
            });
            document.querySelectorAll('[id$="verify"]').forEach(btn => {
                btn.style.display = 'inline-block';
            });
            document.querySelectorAll('[id$="continue"]').forEach(btn => {
                btn.style.display = 'none';
            });
            document.getElementById('progress').style.width = '0%';
            document.querySelectorAll('.hint').forEach(hint => {
                hint.style.display = 'none';
            });
            
            initializeRandomOptions();
            
            setTimeout(() => {
                document.getElementById('scene-intro').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 300);
        }

        // Inicializar eventos de arrastrar y soltar para planificación
        document.addEventListener('DOMContentLoaded', function() {
            const planificacionContainer = document.getElementById('planificacion-container');
            if (planificacionContainer) {
                planificacionContainer.addEventListener('drop', dropPlanificacion);
                planificacionContainer.addEventListener('dragover', allowDropPlanificacion);
            }
        });
    </script>

        <!-- Contenedor del control de volumen -->
    <div id="volumeControl" class="volume-control">
        <button id="volumeToggle" class="volume-toggle" title="Silenciar/Activar sonido">
            <svg class="volume-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path id="volumeIconPath" d="M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z"/>
            </svg>
        </button>
        
        <div class="volume-slider-container">
            <input type="range" 
                id="volumeSlider" 
                class="volume-slider"
                min="0" 
                max="100" 
                value="25"
                step="1"
                aria-label="Control de volumen">
            <div class="volume-tooltip" id="volumeTooltip">25%</div>
        </div>
    </div>

    <!-- Sonido -->
    <audio id="backgroundMusic" loop preload="auto">
        <source src="Musica de fondo.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>
    <audio id="sonidoBotonJugar" preload="auto">
        <source src="boton_jugar.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>
    <audio id="sonidoBotonContinuar" preload="auto">
        <source src="boton_continuar.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>
    <audio id="sonidoRespuestaCorrecta" preload="auto">
        <source src="respuesta_correcta.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>
    <audio id="sonidoRespuestaIncorrecta" preload="auto">
        <source src="respuesta_incorrecta.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>
    <audio id="sonidoUrgencia" preload="auto">
        <source src="urgencia.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
    </audio>

    <script>
        // GESTIÓN DE LA MÚSICA DE FONDO

        document.addEventListener('DOMContentLoaded', function() {
        const music = document.getElementById('backgroundMusic');
        
        if (!music) return;
        
        // Configuración inicial
        music.volume = 0.25;
        
        let musicStarted = false;
        let musicEnabled = true;
        
        // Función para iniciar la música
        function startBackgroundMusic() {
            if (!musicStarted && musicEnabled && music.paused) {
            music.play().then(() => {
                console.log('Música de fondo activada');
                musicStarted = true;
            }).catch(error => {
                console.warn('Autoplay bloqueado por el navegador:', error);
                // Ofrecer botón de inicio manual
                createMusicButton();
            });
            }
        }
        
        // Crear botón de inicio manual si autoplay bloqueado
        function createMusicButton() {
            // Verificar si el botón ya existe
            if (document.getElementById('musicToggleBtn')) return;
            
            const button = document.createElement('button');
            button.id = 'musicToggleBtn';
            button.innerHTML = 'Activar música';
            button.title = 'Haz clic para activar/desactivar la música de fondo';
            
            // Estilos del botón
            button.style.cssText = `
                position: fixed;
                bottom: 80px;
                right: 20px;
                z-index: 10000;
                padding: 10px 15px;
                background: rgba(16, 42, 87, 0.95);
                color: #64ffda;
                border: 1px solid #64ffda;
                border-radius: 8px;
                cursor: pointer;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                transition: all 0.3s ease;
                backdrop-filter: blur(5px);
            `;
            
            // Efecto hover
            button.addEventListener('mouseenter', function() {
                this.style.background = '#64ffda';
                this.style.color = '#0a192f';
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 6px 20px rgba(100, 255, 218, 0.4)';
            });
            
            button.addEventListener('mouseleave', function() {
                this.style.background = musicEnabled ? 'rgba(16, 42, 87, 0.95)' : 'rgba(255, 107, 107, 0.2)';
                this.style.color = musicEnabled ? '#64ffda' : '#ff6b6b';
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.3)';
            });
            
            // Funcionalidad del botón
            button.addEventListener('click', function() {
            if (music.paused) {
                music.play().then(() => {
                    musicEnabled = true;
                    this.innerHTML = 'Música activada';
                    this.style.background = 'rgba(16, 42, 87, 0.95)';
                    this.style.color = '#64ffda';
                    this.style.borderColor = '#64ffda';
                }).catch(e => {
                    console.error('Error de reproducción:', e);
                    this.innerHTML = 'Error de audio';
                    this.style.background = 'rgba(255, 107, 107, 0.2)';
                    this.style.color = '#ff6b6b';
                    this.style.borderColor = '#ff6b6b';
                });
            } else {
                music.pause();
                musicEnabled = false;
                this.innerHTML = 'Activar música';
                this.style.background = 'rgba(255, 107, 107, 0.1)';
                this.style.color = '#ff6b6b';
                this.style.borderColor = 'rgba(255, 107, 107, 0.3)';
            }
            });
            
            document.body.appendChild(button);
        }
        
        // Iniciar música al primer clic
        const startEvents = ['click', 'touchstart', 'keydown'];
        startEvents.forEach(eventType => {
            document.addEventListener(eventType, startBackgroundMusic, { 
            once: true,
            passive: true 
            });
        });
        
        // GESTIÓN DE LA VISIBILIDAD DE LA PÁGINA
        
        // Bajar volumen cuando la página no está visible
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Página oculta: bajar volumen
                if (!music.paused) {
                    music.volume = 0.1;
                }
            } else {
                // Página visible: restaurar volumen
                if (!music.paused) {
                    updateMusicForTimer();
                }
            }
        });

        // GESTIÓN DE ERRORES
        
        music.addEventListener('error', function(e) {
            console.error('Error de audio:', e);
            const errorCode = music.error ? music.error.code : 'desconocido';
            const errorMessages = {
                1: 'MEDIA_ERR_ABORTED - Reproducción cancelada',
                2: 'MEDIA_ERR_NETWORK - Error de red',
                3: 'MEDIA_ERR_DECODE - Archivo de audio corrupto',
                4: 'MEDIA_ERR_SRC_NOT_SUPPORTED - Formato no soportado'
            };
            
            console.warn('Problema con el archivo de audio:', errorMessages[errorCode] || 'Error desconocido');
            
            // Mostrar mensaje discreto
            if (!document.getElementById('audioErrorMsg')) {
            const msg = document.createElement('div');
            msg.id = 'audioErrorMsg';
            msg.textContent = 'No se pudo cargar la música de fondo';
            msg.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(255, 107, 107, 0.9);
                color: white;
                padding: 8px 15px;
                border-radius: 5px;
                font-size: 12px;
                z-index: 9999;
                display: none;
            `;
            document.body.appendChild(msg);
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 5000);
            }
        });
        
        // DETECCIÓN DEL BUCLE
        
        // Detectar cuando la música se repite
        let loopCount = 0;
        music.addEventListener('timeupdate', function() {
            // Si esta cerca del final y vuelve al inicio
            if (music.currentTime > music.duration - 0.5 && music.currentTime < 1) {
            loopCount++;
            console.log(`Bucle ${loopCount} completado`);
            }
        });
        
        // FUNCIÓN PARA REINICIAR MÚSICA
        
        // Añadir a restartGame()
        if (typeof restartGame === 'function') {
            const originalRestartGame = restartGame;
            restartGame = function() {
            originalRestartGame();
            // Reiniciar música
            if (music) {
                music.currentTime = 0;
                music.volume = 0.25;
                music.playbackRate = 1.0;
                if (!musicStarted) {
                startBackgroundMusic();
                }
            }
            };
        }
        });

        // CONTROLES DE VOLUMEN

        document.addEventListener('DOMContentLoaded', function() {
        const music = document.getElementById('backgroundMusic');
        const volumeControl = document.getElementById('volumeControl');
        const volumeToggle = document.getElementById('volumeToggle');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeTooltip = document.getElementById('volumeTooltip');
        const volumeIconPath = document.getElementById('volumeIconPath');
        
        if (!music || !volumeToggle || !volumeSlider) return;
        
        // Estado inicial
        let isMuted = false;
        let lastVolume = 25;
        
        // Iconos SVG para diferentes estados
        const volumeIcons = {
            high: "M14.667 0v2.747c3.853 1.146 6.666 4.72 6.666 8.946 0 4.227-2.813 7.787-6.666 8.934v2.76C20 22.173 24 17.4 24 11.693 24 5.987 20 1.213 14.667 0zM18 11.693c0-2.36-1.333-4.386-3.333-5.373v10.707c2-.947 3.333-2.987 3.333-5.334zm-18-4v8h5.333L12 22.36V1.027L5.333 7.693H0z",
            medium: "M0 7.667v8h5.333L12 22.333V1L5.333 7.667M17.333 11.373c0-2.573-1.221-4.834-3.061-5.973v11.946c1.84-1.14 3.061-3.4 3.061-5.973z",
            low: "M0 7.667v8h5.333L12 22.333V1L5.333 7.667M14.667 13.613c0-1.147-.92-2.086-2.057-2.086-.238 0-.467.047-.68.127v3.893c.213.08.442.127.68.127 1.137.02 2.057-.92 2.057-2.061z",
            muted: "M0 7.667v8h5.333L12 22.333V1L5.333 7.667M19.333 4.273l-1.88-1.88-3.78 3.78-3.78-3.78-1.88 1.88 3.78 3.78-3.78 3.78 1.88 1.88 3.78-3.78 3.78 3.78 1.88-1.88-3.78-3.78z"
        };
        
        // Actualizar icono según volumen
        function updateVolumeIcon(volume) {
            let iconPath = volumeIcons.high;
            
            if (isMuted || volume === 0) {
                iconPath = volumeIcons.muted;
                volumeControl.classList.add('muted');
            } else {
                volumeControl.classList.remove('muted');
            if (volume < 33) {
                iconPath = volumeIcons.low;
            } else if (volume < 66) {
                iconPath = volumeIcons.medium;
            } else {
                iconPath = volumeIcons.high;
            }
            }
            
            if (volumeIconPath) {
                volumeIconPath.setAttribute('d', iconPath);
            }
        }
        
        // Actualizar tooltip
        function updateVolumeTooltip(value) {
            if (volumeTooltip) {
                volumeTooltip.textContent = `${value}%`;
            }
        }
        
        // Actualizar volumen de los sonidos
        function updateMusicVolume(value) {
            const volume = value / 100;
            
            // Actualizar volumen de TODOS los sonidos
            const allSounds = document.querySelectorAll('audio');
            allSounds.forEach(sound => {
                // Solo actualizar si no es la música de fondo
                if (sound.id !== 'backgroundMusic') {
                    sound.volume = volume;
                } else {
                    sound.volume = volume; // La música ya se actualiza aparte
                }
            });
            
            // Guardar último volumen si no está muteado
            if (value > 0) {
                lastVolume = value;
            }
            
            updateVolumeIcon(value);
            updateVolumeTooltip(value);
        }
        
        // Función para mute/unmute
        function toggleMute() {
            if (isMuted) {
                // Desmuteado: restaurar último volumen
                music.volume = lastVolume / 100;
                volumeSlider.value = lastVolume;
                isMuted = false;
            } else {
                // Muteado: guardar volumen actual y poner a 0
                lastVolume = volumeSlider.value;
                music.volume = 0;
                volumeSlider.value = 0;
                isMuted = true;
            }
            
            updateVolumeIcon(volumeSlider.value);
            updateVolumeTooltip(volumeSlider.value);
        }
        
        // Event listeners
        volumeToggle.addEventListener('click', toggleMute);
        
        volumeSlider.addEventListener('input', function() {
            const value = parseInt(this.value);
            updateMusicVolume(value);
            isMuted = value === 0;
        });
        
        volumeSlider.addEventListener('change', function() {
            const value = parseInt(this.value);
            updateMusicVolume(value);
            isMuted = value === 0;
        });
        
        // Efecto hover en el slider
        volumeSlider.addEventListener('mousedown', function() {
            volumeTooltip.style.opacity = '1';
        });
        
        volumeSlider.addEventListener('mouseup', function() {
            setTimeout(() => {
                if (!volumeSlider.matches(':hover')) {
                    volumeTooltip.style.opacity = '0';
                }
            }, 500);
        });
        
        volumeSlider.addEventListener('mouseenter', function() {
            volumeTooltip.style.opacity = '1';
        });
        
        volumeSlider.addEventListener('mouseleave', function() {
            volumeTooltip.style.opacity = '0';
        });
        
        // Teclado : atajos de volumen
        document.addEventListener('keydown', function(event) {
            // Alt + Flecha arriba: subir volumen
            if (event.altKey && event.key === 'ArrowUp') {
                event.preventDefault();
                let newVolume = parseInt(volumeSlider.value) + 10;
                if (newVolume > 100) newVolume = 100;
                volumeSlider.value = newVolume;
                updateMusicVolume(newVolume);
                showVolumeNotification(newVolume);
            }
            
            // Alt + Flecha abajo: bajar volumen
            else if (event.altKey && event.key === 'ArrowDown') {
                event.preventDefault();
                let newVolume = parseInt(volumeSlider.value) - 10;
                if (newVolume < 0) newVolume = 0;
                volumeSlider.value = newVolume;
                updateMusicVolume(newVolume);
                showVolumeNotification(newVolume);
            }
            
            // Alt + M: mute/unmute
            else if (event.altKey && event.key.toLowerCase() === 'm') {
                event.preventDefault();
                toggleMute();
                showMuteNotification(isMuted);
            }
        });
        
        // Notificación temporal de volumen
        function showVolumeNotification(volume) {
            const notification = document.createElement('div');
            notification.className = 'volume-notification';
            notification.innerHTML = `Volumen: ${volume}%`;
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(16, 42, 87, 0.95);
                color: #64ffda;
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid #64ffda;
                font-size: 14px;
                font-weight: bold;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            
            document.body.appendChild(notification);
            
            // Animación de aparición/desaparición
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 1000);
        }
        
        // Notificación de mute/unmute
        function showMuteNotification(muted) {
            const notification = document.createElement('div');
            notification.className = 'mute-notification';
            notification.innerHTML = muted ? 'Sonido silenciado' : 'Sonido activado';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(16, 42, 87, 0.95);
                color: ${muted ? '#ff6b6b' : '#64ffda'};
                padding: 12px 20px;
                border-radius: 8px;
                border: 1px solid ${muted ? '#ff6b6b' : '#64ffda'};
                font-size: 14px;
                font-weight: bold;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 1000);
        }
        
        // Inicializar controles
        updateMusicVolume(25);
        updateVolumeIcon(25);
        updateVolumeTooltip(25);
        
        // Guardar preferencias de volumen en LocalStorage
        function saveVolumePreferences() {
            const preferences = {
                volume: volumeSlider.value,
                muted: isMuted,
                lastVolume: lastVolume
            };
            localStorage.setItem('escapeGameVolume', JSON.stringify(preferences));
        }
        
        // Cargar preferencias guardadas
        function loadVolumePreferences() {
            const saved = localStorage.getItem('escapeGameVolume');
            if (saved) {
                try {
                    const preferences = JSON.parse(saved);
                    volumeSlider.value = preferences.volume;
                    isMuted = preferences.muted;
                    lastVolume = preferences.lastVolume || 25;
                    
                    if (isMuted) {
                        music.volume = 0;
                    } else {
                        updateMusicVolume(preferences.volume);
                    }
                    
                    updateVolumeIcon(preferences.volume);
                    updateVolumeTooltip(preferences.volume);
                } catch (e) {
                    console.warn('Error cargando preferencias de volumen:', e);
                }
            }
        }
        
        // Cargar preferencias al inicio
        loadVolumePreferences();
        
        // Guardar preferencias al cambiar volumen
        volumeSlider.addEventListener('change', saveVolumePreferences);
        volumeToggle.addEventListener('click', saveVolumePreferences);
        
        // Guardar cada 30 segundos
        setInterval(saveVolumePreferences, 30000);
        });
    </script>

    <style>
        #musicToggleBtn:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 25px rgba(100, 255, 218, 0.5) !important;
        }

        #musicToggleBtn:active {
            transform: translateY(1px) !important;
        }

        @keyframes pulse-gentle {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }

        #musicToggleBtn:not(:hover) {
            animation: pulse-gentle 3s infinite;
        }

        #audioErrorMsg {
            animation: fadeInOut 5s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
        }

        /* CONTROLES DE VOLUMEN */

        .volume-control {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(16, 42, 87, 0.9);
            backdrop-filter: blur(10px);
            padding: 8px 12px;
            border-radius: 30px;
            border: 1px solid rgba(100, 255, 218, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .volume-control:hover {
            opacity: 1;
            border-color: #64ffda;
            box-shadow: 0 6px 25px rgba(100, 255, 218, 0.2);
            transform: translateY(-2px);
        }

        .volume-toggle {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: #64ffda;
            width: 36px;
            height: 36px;
        }

        .volume-toggle:hover {
            background: rgba(100, 255, 218, 0.1);
            color: #a8ffeb;
            transform: scale(1.1);
        }

        .volume-toggle:active {
            transform: scale(0.95);
        }

        .volume-icon {
            transition: all 0.3s ease;
        }

        .volume-slider-container {
            position: relative;
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        .volume-control:hover .volume-slider-container {
            width: 120px;
        }

        .volume-slider {
            width: 100%;
            height: 6px;
            background: rgba(35, 53, 84, 0.8);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            border: 2px solid #0a192f;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
            transition: all 0.2s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            background: #a8ffeb;
            transform: scale(1.2);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.7);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64ffda;
            cursor: pointer;
            border: 2px solid #0a192f;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
        }

        .volume-slider::-moz-range-track {
            background: rgba(35, 53, 84, 0.8);
            height: 6px;
            border-radius: 3px;
        }

        .volume-tooltip {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(16, 42, 87, 0.95);
            color: #64ffda;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            border: 1px solid rgba(100, 255, 218, 0.2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .volume-slider-container:hover .volume-tooltip {
            opacity: 1;
        }

        .volume-control.muted .volume-icon {
            color: #ff6b6b;
        }

        .volume-control.muted .volume-slider::-webkit-slider-thumb {
            background: #ff6b6b;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        @media (max-width: 768px) {
            .volume-control {
                bottom: 15px;
                left: 15px;
                padding: 6px 10px;
            }
            
            .volume-toggle {
                width: 32px;
                height: 32px;
            }
            
            .volume-icon {
                width: 16px;
                height: 16px;
            }
            
            .volume-control:hover .volume-slider-container {
                width: 100px;
            }
            
            .volume-slider::-webkit-slider-thumb {
                width: 16px;
                height: 16px;
            }
        }

        @media (max-width: 480px) {
            .volume-control {
                bottom: 10px;
                left: 10px;
                padding: 5px 8px;
            }
            
            .volume-control:hover .volume-slider-container {
                width: 80px;
            }
        }

        .audio-muted {
            filter: grayscale(100%);
            opacity: 0.5;
        }
    </style>
</body>
</html>